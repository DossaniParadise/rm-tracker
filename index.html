<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Dossani Paradise Repair and Maintenance Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="exp-manager-mobile">

<!-- ============================================================
     LOGIN SCREEN
     ============================================================ -->
<div class="login-container" id="loginScreen">
    <div class="login-card">
        <img src="logos/dpm-logo.png" alt="DPM" style="height:44px;margin-bottom:18px;object-fit:contain">
        <h1 class="login-title">Repair &amp; Maintenance Tracker</h1>
        <p class="login-subtitle">Dossani Paradise Management</p>

        <!-- Login Form -->
        <div id="loginForm">
            <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">
                Enter your email to receive a secure sign-in link.
            </p>
            <div class="form-group">
                <input
                    type="email"
                    id="loginEmail"
                    class="form-input"
                    placeholder="you@dossaniparadise.com"
                    autocomplete="email"
                >
            </div>
            <button class="btn btn-primary btn-full" onclick="sendSignInLink()" id="sendLinkBtn">
                Send Sign-In Link
            </button>
        </div>

        <!-- Email Sent Confirmation -->
        <div id="emailSentMessage" class="hidden" style="text-align: center;">
            <div style="font-size: 44px; margin-bottom: 12px;">üìß</div>
            <h3 style="margin-bottom: 6px; font-size: 18px;">Check your inbox</h3>
            <p style="color: var(--text-muted); margin-bottom: 14px; font-size: 14px;">
                We sent a sign-in link to<br>
                <strong id="sentToEmail" style="color: var(--text);"></strong>
            </p>
            <div style="background: #fef9ee; border: 1px solid #fde68a; border-radius: 8px; padding: 10px 14px; margin-bottom: 16px;">
                <p style="color: var(--accent); font-size: 13px;">
                    ‚ö†Ô∏è Check your <strong>spam/junk folder</strong> if you don't see it
                </p>
            </div>
            <button class="btn btn-ghost btn-full" onclick="resendEmail()">
                Send Another Link
            </button>
        </div>

        <div id="loginError" class="error-message hidden"></div>
    </div>
</div>

<!-- ============================================================
     MAIN APP
     ============================================================ -->
<div class="app-container" id="appContainer">

    <!-- Header -->
    <div class="app-header">
        <div class="header-left">
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle dark mode">üåô</button>
            <button class="theme-toggle" id="langToggle" onclick="toggleLang()" title="Espa√±ol / English">EN</button>
            <a class="header-logo" href="#" onclick="goHome();return false" style="text-decoration:none;display:flex;align-items:center;gap:8px;cursor:pointer"><img src="logos/dpm-icon.png" alt="DPM" style="height:24px;vertical-align:middle"><span class="header-title">Repair &amp; Maintenance</span></a>
        </div>
        <div class="header-right">
            <div class="user-badge">
                <div class="user-avatar" id="userAvatar">?</div>
                <div class="user-meta">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role-tag" id="userRole">...</div>
                </div>
            </div>
            <button class="admin-btn hidden" id="adminBtn" onclick="showAdminPanel()">‚öôÔ∏è <span class="badge hidden" id="pendingBadge">0</span></button>
            <button class="admin-btn hidden" id="vendorBtn" onclick="showVendorManager()" title="Manage approved vendors">üè¢‚öôÔ∏è</button>
            <button class="admin-btn hidden" id="notifyBtn" onclick="toggleNotifyPanel()" style="position:relative">üîî <span class="badge hidden" id="notifyBadge" style="background:#dc2626">0</span></button>
            <button class="admin-btn hidden" id="viewAsBtn" onclick="showViewAsModal()">üëÅ View As</button>
            <button class="btn-logout" onclick="logout()" data-i18n="sign_out">Sign Out</button>
        </div>
    </div>

    <!-- Notification Panel (dropdown) -->
    <div class="notify-panel" id="notifyPanel">
        <div class="notify-panel-header">
            <span data-i18n="notifications">Notifications</span>
            <button onclick="toggleNotifyPanel()" style="background:none;border:none;cursor:pointer;font-size:16px;color:var(--text-muted)">‚úï</button>
        </div>
        <div class="notify-panel-body" id="notifyPanelBody">
            <div class="notify-empty">Loading...</div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="app-content">

        <!-- ===== SCREEN: Tech Dashboard (Technicians only) ===== -->
        <div id="techDashboard" class="hidden">
            <div class="tech-dash-header">
                <h2 data-i18n="tech_my_jobs">üîß My Jobs</h2>
                <div class="tech-dash-filters">
                    <button class="filter-chip active" data-filter="active" onclick="filterTechJobs('active', this)" data-i18n="tech_active">Active</button>
                    <button class="filter-chip" data-filter="completed" onclick="filterTechJobs('completed', this)" data-i18n="tech_completed">Completed</button>
                </div>
            </div>

            <!-- Active clock-in banner -->
            <div id="techClockBanner" class="tech-clock-banner hidden">
                <div class="tcb-info">
                    <span class="tcb-status" data-i18n="tech_clocked_in">‚è±Ô∏è Clocked In</span>
                    <span class="tcb-ticket" id="tcbTicketId"></span>
                    <span class="tcb-store" id="tcbStoreName"></span>
                    <span class="tcb-emergency hidden" id="tcbEmergency">üö® Emergency</span>
                </div>
                <div class="tcb-timer" id="tcbTimer">00:00:00</div>
                <div class="tech-banner-actions">
                    <button class="btn-tech-primary" id="techPrimaryActionBtn" onclick="techAdvanceExecutionMode()">üöó Start Travel</button>
                    <button class="btn btn-sm" style="background:#dc2626;color:#fff;border:none" onclick="showClockOutPrompt()" data-i18n="tech_clock_out">Clock Out</button>
                </div>
            </div>

            <!-- Summary stats -->
            <div class="tech-stats" id="techStats"></div>

            <div class="tech-layout" id="techLayout">
                <div class="tech-list-pane">
                    <!-- Job list -->
                    <div class="tech-job-list" id="techJobList">
                        <div class="empty-state" data-i18n="tech_loading">Loading jobs...</div>
                    </div>
                </div>
                <div class="tech-detail-pane" id="techDetailPane">
                    <div class="tech-detail-empty" data-i18n="tech_select_job">Select a job to view full details.</div>
                </div>
            </div>

            <div class="tech-mobile-footer hidden" id="techMobileFooter">
                <button class="btn-tech-primary" id="techMobilePrimaryBtn" onclick="techAdvanceExecutionMode()">üöó Start Travel</button>
                <button class="btn" style="background:#dc2626;color:#fff;border:none" onclick="showClockOutPrompt()" data-i18n="tech_clock_out">Clock Out</button>
            </div>
        </div>

        <!-- ===== SCREEN: Admin Summary (top of store selection for admins) ===== -->
        <div id="adminSummary" class="hidden">
            <div class="admin-summary-grid" id="adminSummaryGrid"></div>
        </div>

        <!-- ===== SCREEN: Manager Landing ===== -->
        <div id="managerLanding" class="hidden">
            <div class="role-landing">
                <div id="mgrStoreName" class="landing-store-name"></div>
                <div class="landing-actions">
                    <div class="action-card" onclick="showNewIssueScreen()">
                        <div class="action-icon">üìù</div>
                        <div class="action-title" data-i18n="report_issue">Report New Issue</div>
                        <div class="action-desc" data-i18n="report_issue_desc">Submit a repair ticket</div>
                    </div>
                    <div class="action-card" onclick="showExistingIssuesScreen()">
                        <div class="action-icon">üìã</div>
                        <div class="action-title" data-i18n="view_tickets">Existing Tickets</div>
                        <div class="action-desc" data-i18n="view_tickets_desc">View and track unassigned issues</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: Coach Landing ===== -->
        <div id="coachLanding" class="hidden">
            <div class="role-landing">
                <div class="landing-header">
                    <h2 data-i18n="coach_my_stores">My Stores</h2>
                </div>
                <div class="landing-actions" id="coachStoreGrid"></div>
                <div style="text-align:center;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
                    <button class="btn btn-primary" onclick="showAllTickets('unassigned')" style="padding:14px 32px;font-size:15px;border-radius:12px;font-weight:600" data-i18n="view_all_tickets">üîç View All Unassigned Tickets</button>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: Coach Store View (2 buttons for selected store) ===== -->
        <div id="coachStoreView" class="hidden">
            <div class="role-landing">
                <button class="btn-back" onclick="showScreen('coachLanding');initCoachLanding()" style="margin-bottom:12px" data-i18n="back_my_stores">‚Üê Back to My Stores</button>
                <div id="coachSelectedStoreName" class="landing-store-name"></div>
                <div class="landing-actions">
                    <div class="action-card" onclick="showNewIssueScreen()">
                        <div class="action-icon">üìù</div>
                        <div class="action-title" data-i18n="report_issue">Report New Issue</div>
                        <div class="action-desc" data-i18n="report_issue_desc">Submit a repair ticket</div>
                    </div>
                    <div class="action-card" onclick="showExistingIssuesScreen()">
                        <div class="action-icon">üìã</div>
                        <div class="action-title" data-i18n="view_tickets">Existing Tickets</div>
                        <div class="action-desc" data-i18n="view_tickets_desc">View and track unassigned issues</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: Store Selection ===== -->
        <div id="storeSelection">
            <div class="store-card">
                <div class="store-card-header">
                    <h2 data-i18n="select_store">Select Your Store</h2>
                    <p data-i18n="select_store_sub">Choose a location to report or check issues</p>
                </div>

                <!-- Brand buttons - clickable, trigger store type + map -->
                <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:12px;padding:0 8px">
                    <button onclick="selectBrand('all')" class="brand-pill hidden" id="brandPill-all">
                        <span class="brand-pill-icon" style="background:var(--primary);color:#fff;font-size:14px;font-weight:700">üìç</span>
                        <span data-i18n="all_locations">All Locations</span>
                    </button>
                    <button onclick="selectBrand('fastfood')" class="brand-pill" id="brandPill-fastfood">
                        <span class="brand-pill-icon"><img src="logos/bk-logo.png" alt=""></span>
                        <span data-i18n="brand_fastfood">Fast Food</span>
                    </button>
                    <button onclick="selectBrand('cstore')" class="brand-pill" id="brandPill-cstore">
                        <span class="brand-pill-icon"><img src="logos/pqs-logo.png" alt=""></span>
                        <span data-i18n="brand_cstore">C-Store</span>
                    </button>
                    <button onclick="selectBrand('carwash')" class="brand-pill" id="brandPill-carwash">
                        <span class="brand-pill-icon"><img src="logos/cw-logo.png" alt=""></span>
                        <span data-i18n="brand_carwash">Car Wash</span>
                    </button>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="store_type">Store Type</label>
                        <select class="form-select" id="storeType" onchange="filterStores()">
                            <option value="">Choose type...</option>
                            <option value="all" class="admin-only-opt hidden">All Locations</option>
                            <option value="fastfood">Fast Food</option>
                            <option value="cstore">C-Store</option>
                            <option value="carwash">Car Wash</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_location">Location</label>
                        <select class="form-select" id="storeSelect" onchange="selectStore()">
                            <option value="">Choose store...</option>
                        </select>
                    </div>
                </div>

                <div id="actionButtons" class="action-grid hidden">
                    <div class="action-card" onclick="showNewIssueScreen()">
                        <div class="action-icon">üìù</div>
                        <div class="action-title" data-i18n="report_issue">Report New Issue</div>
                        <div class="action-desc" data-i18n="report_issue_desc">Submit a repair ticket</div>
                    </div>
                    <div class="action-card" onclick="showExistingIssuesScreen()">
                        <div class="action-icon">üìã</div>
                        <div class="action-title" data-i18n="view_tickets">Existing Tickets</div>
                        <div class="action-desc" data-i18n="view_tickets_desc">View and track unassigned issues</div>
                    </div>
                </div>

                <!-- Desktop: store list with ticket counts -->
                <div class="desktop-store-list" id="desktopStoreList" style="display:none"></div>
            </div>


            <!-- Map Overview (for Admin/Area Coach after type selection) -->
            <div id="mapOverview" class="hidden">
                <div class="map-card">
                    <div class="map-header">
                        <h2 id="mapTitle">Store Overview</h2>
                        <div class="map-view-toggle" id="mapViewToggle">
                            <button class="active" onclick="setMapView('map')">üìç Map</button>
                            <button onclick="setMapView('list')">üìã List</button>
                        </div>
                        <div class="map-legend">
                            <span><span class="dot dot-green"></span> No issues</span>
                            <span><span class="dot dot-yellow"></span> Has Issues</span>
                            <span><span class="dot dot-red"></span> Critical</span>
                        </div>
                    </div>
                    <div id="overviewMap"></div>
                    <div id="storeListView" class="store-list-view" style="display:none"></div>
                    <div class="map-stats-bar" id="mapStatsBar"></div>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: New Issue Form ===== -->
        <div id="newIssueScreen" class="hidden">
            <div class="back-row">
                <button class="btn-back" onclick="goBack()" data-i18n="back_store">‚Üê Back to store</button>
            </div>

            <div class="issue-form-card">
                <div class="issue-form-header">
                    <h2 data-i18n="report_new">Report New Issue</h2>
                    <p id="newIssueStoreName">Store Name</p>
                </div>

                <div class="issue-form-body">
                    <div class="full-form-mode">
                    <!-- Category -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_category">Category</label>
                        <div class="category-grid" id="categoryGrid">
                            <button class="category-btn" data-cat="plumbing" onclick="selectCategory(this)">
                                <span class="cat-icon">üöø</span>
                                <span class="cat-label" data-i18n="cat_plumbing">Plumbing</span>
                            </button>
                            <button class="category-btn" data-cat="equipment" onclick="selectCategory(this)">
                                <span class="cat-icon">‚öôÔ∏è</span>
                                <span class="cat-label" data-i18n="cat_equipment">Equipment</span>
                            </button>
                            <button class="category-btn" data-cat="it" onclick="selectCategory(this)">
                                <span class="cat-icon">üíª</span>
                                <span class="cat-label" data-i18n="cat_it">IT</span>
                            </button>
                            <button class="category-btn" data-cat="structural" onclick="selectCategory(this)">
                                <span class="cat-icon">üß±</span>
                                <span class="cat-label" data-i18n="cat_structural">Structural</span>
                            </button>
                            <button class="category-btn" data-cat="safety" onclick="selectCategory(this)">
                                <span class="cat-icon">üõ°Ô∏è</span>
                                <span class="cat-label" data-i18n="cat_safety">Safety</span>
                            </button>
                            <button class="category-btn" data-cat="other" onclick="selectCategory(this)">
                                <span class="cat-icon">üìé</span>
                                <span class="cat-label" data-i18n="cat_other">Other</span>
                            </button>
                        </div>
                    </div>

                    <!-- Interior / Exterior -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_location">Location</label>
                        <div class="priority-options" style="max-width:280px">
                            <button class="priority-btn" data-loc="interior" onclick="selectLocation(this)">
                                <span class="priority-icon">üè†</span>
                                <span class="priority-label" data-i18n="loc_interior">Interior</span>
                            </button>
                            <button class="priority-btn" data-loc="exterior" onclick="selectLocation(this)">
                                <span class="priority-icon">üè™</span>
                                <span class="priority-label" data-i18n="loc_exterior">Exterior</span>
                            </button>
                        </div>
                    </div>

                    <!-- Contact Info -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_name">Your Name</label>
                        <input class="form-input" type="text" id="contactName" placeholder="Name of person reporting issue" autocomplete="off" oninput="saveNewIssueDraft()">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_phone">Your Contact Phone</label>
                        <input class="form-input" type="tel" id="contactPhone" placeholder="555-123-4567" inputmode="tel" maxlength="12" oninput="formatPhone(this)">
                    </div>

                    <!-- Priority -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_priority">Priority</label>
                        <div class="priority-options">
                            <button class="priority-btn p-routine" data-priority="routine" onclick="selectPriority(this)">
                                <span class="priority-icon">üü¢</span>
                                <span class="priority-label" data-i18n="p_routine">Routine</span>
                                <span class="priority-desc" data-i18n="p_routine_desc">Up to 1 week</span>
                            </button>
                            <button class="priority-btn p-urgent" data-priority="urgent" onclick="selectPriority(this)">
                                <span class="priority-icon">üü°</span>
                                <span class="priority-label" data-i18n="p_urgent">Urgent</span>
                                <span class="priority-desc" data-i18n="p_urgent_desc">Within 72 hours</span>
                            </button>
                            <button class="priority-btn p-emergency" data-priority="emergency" onclick="selectPriority(this)">
                                <span class="priority-icon">üî¥</span>
                                <span class="priority-label" data-i18n="p_emergency">Emergency</span>
                                <span class="priority-desc" data-i18n="p_emergency_desc">Within 24 hours</span>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Requested Date</label>
                        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
                            <select class="form-select" id="reqDateType" onchange="toggleDateFields()" style="max-width:140px">
                                <option value="">No date</option>
                                <option value="specific">Specific date</option>
                                <option value="before">Before date</option>
                                <option value="range">Date range</option>
                            </select>
                            <input type="date" class="form-input" id="reqDate1" style="display:none;max-width:160px">
                            <span id="reqDateRangeSep" style="display:none;font-size:12px;color:var(--text-muted)">to</span>
                            <input type="date" class="form-input" id="reqDate2" style="display:none;max-width:160px">
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_description">Description</label>
                        <textarea class="form-textarea" id="issueDescription" placeholder="Describe the issue in detail. What's broken? Where exactly? When did it start?" oninput="saveNewIssueDraft()"></textarea>
                    </div>

                    <!-- Photos -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_photos">Photos <span style="font-weight:400; color: var(--text-muted);" data-i18n="form_photos_hint">(optional, up to 3)</span></label>
                        <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click()">
                            <div class="upload-icon">üì∑</div>
                            <div class="upload-text" data-i18n="tap_photos">Tap to add photos</div>
                            <div class="upload-hint" data-i18n="photo_hint">JPG or PNG, max 5MB each</div>
                        </div>
                        <input type="file" id="photoInput" accept="image/*" capture="environment" multiple style="display:none" onchange="handlePhotos(this)">
                        <div class="photo-preview-grid" id="photoPreviewGrid"></div>
                    </div>
                    </div>

                    <div class="wizard-container" id="newIssueWizard">
                        <div class="wizard-step-chip-row" id="wizardStepChips"></div>

                        <div class="wizard-step" data-step="1">
                            <div class="wizard-title">Step 1: Pick location</div>
                            <div class="wizard-subtitle">Choose the store where the issue is happening.</div>
                            <div id="wizardStoreList" class="wizard-store-list"></div>
                        </div>

                        <div class="wizard-step" data-step="2">
                            <div class="wizard-title">Step 2: Pick category</div>
                            <div class="wizard-subtitle">Tap the issue type.</div>
                            <div class="wizard-touch-grid" id="wizardCategoryGrid"></div>
                        </div>

                        <div class="wizard-step" data-step="3">
                            <div class="wizard-title">Step 3: Add photo first</div>
                            <div class="wizard-subtitle">Take a picture now so the repair team can quickly triage.</div>
                            <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                                <div class="upload-icon">üì∏</div>
                                <div class="upload-text">Open camera / photos</div>
                                <div class="upload-hint">Tip: Include the full area and close-up detail.</div>
                            </div>
                            <div class="wizard-photo-hint">You can submit without a photo, but adding one improves first-time fix rates.</div>
                            <div class="photo-preview-grid" id="wizardPhotoPreviewGrid"></div>
                        </div>

                        <div class="wizard-step" data-step="4">
                            <div class="wizard-title">Step 4: Describe issue</div>
                            <div class="wizard-subtitle">Dictation friendly: tap the mic on your keyboard and speak naturally.</div>
                            <textarea class="form-textarea" id="wizardIssueDescription" placeholder="Try: 'Ice machine leaking behind left panel since this morning.'" oninput="saveNewIssueDraft()"></textarea>
                            <div class="wizard-dictation-row">
                                <button class="btn btn-secondary" type="button" onclick="copyWizardDescriptionToMain()">Use this description</button>
                            </div>
                        </div>

                        <div class="wizard-step" data-step="5">
                            <div class="wizard-title">Step 5: Priority</div>
                            <div class="wizard-subtitle">How urgent is this for operations or safety?</div>
                            <div class="priority-options">
                                <button class="priority-btn p-routine" data-priority="routine" onclick="selectPriority(this)">
                                    <span class="priority-icon">üü¢</span>
                                    <span class="priority-label">Routine</span>
                                    <span class="wizard-priority-hint">Still usable. Can wait up to a week.</span>
                                </button>
                                <button class="priority-btn p-urgent" data-priority="urgent" onclick="selectPriority(this)">
                                    <span class="priority-icon">üü°</span>
                                    <span class="priority-label">Urgent</span>
                                    <span class="wizard-priority-hint">Impacts service. Needs attention in 72h.</span>
                                </button>
                                <button class="priority-btn p-emergency" data-priority="emergency" onclick="selectPriority(this)">
                                    <span class="priority-icon">üî¥</span>
                                    <span class="priority-label">Emergency</span>
                                    <span class="wizard-priority-hint">Safety/compliance risk or outage. Act in 24h.</span>
                                </button>
                            </div>
                        </div>

                        <div class="wizard-step" data-step="6">
                            <div class="wizard-title">Step 6: Review + submit</div>
                            <div class="wizard-subtitle">Confirm details, then submit the ticket.</div>
                            <div class="wizard-review-card" id="wizardReviewCard"></div>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="goBack()">Cancel</button>
                        <button class="btn btn-secondary hidden" id="wizardPrevBtn" onclick="wizardPrevStep()">Back</button>
                        <button class="btn btn-secondary hidden" id="wizardNextBtn" onclick="wizardNextStep()">Next</button>
                        <button class="btn btn-primary" onclick="submitTicket()" id="submitBtn">Submit Ticket</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: Existing Issues ===== -->
        <div id="existingIssuesScreen" class="hidden">
            <div class="back-row">
                <button class="btn-back" onclick="goBack()">‚Üê Back to store</button>
            </div>

            <div class="tickets-header">
                <h2 data-i18n="tickets_title">Tickets <span id="ticketStoreName" style="font-weight:400; color: var(--text-muted); font-size: 15px;"></span></h2>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn btn-secondary btn-sm compact-filter-trigger" onclick="toggleCompactFilters(true)">Filters</button>
                    <button class="btn btn-primary btn-sm" onclick="showNewIssueScreen()">+ New Ticket</button>
                </div>
            </div>

            <div class="ticket-filters" id="ticketFilters">
                <button class="filter-chip active" data-filter="all" onclick="filterTickets('all', this)" data-i18n="filter_all">All</button>
                <button class="filter-chip" data-filter="unassigned" onclick="filterTickets('unassigned', this)" data-i18n="filter_open">Unassigned</button>
                <button class="filter-chip" data-filter="assigned" onclick="filterTickets('assigned', this)" data-i18n="filter_assigned">Assigned</button>
                <button class="filter-chip" data-filter="inprogress" onclick="filterTickets('inprogress', this)" data-i18n="filter_inprogress">In Progress</button>
                <button class="filter-chip" data-filter="waiting" onclick="filterTickets('waiting', this)" data-i18n="filter_waiting">Waiting</button>
                <button class="filter-chip" data-filter="resolved" onclick="filterTickets('resolved', this)" data-i18n="filter_resolved">Resolved</button>
                <button class="filter-chip" data-filter="closed" onclick="filterTickets('closed', this)" data-i18n="filter_closed">Closed</button>
            </div>

            <div class="tickets-list" id="ticketsList">
                <!-- Populated by JS -->
            </div>

            <div class="mobile-primary-action-wrap">
                <button class="btn btn-primary" onclick="showNewIssueScreen()">+ New Ticket</button>
            </div>

            <div class="compact-filter-modal" id="compactFilterModal" onclick="if(event.target.id==='compactFilterModal')toggleCompactFilters(false)">
                <div class="compact-filter-sheet">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <strong>Filter tickets</strong>
                        <button class="btn btn-ghost btn-sm" onclick="toggleCompactFilters(false)">Close</button>
                    </div>
                    <div class="ticket-filters" id="compactTicketFilters">
                        <button class="filter-chip active" data-filter="all" onclick="filterTickets('all', this)">All</button>
                        <button class="filter-chip" data-filter="unassigned" onclick="filterTickets('unassigned', this)">Unassigned</button>
                        <button class="filter-chip" data-filter="assigned" onclick="filterTickets('assigned', this)">Assigned</button>
                        <button class="filter-chip" data-filter="inprogress" onclick="filterTickets('inprogress', this)">In Progress</button>
                        <button class="filter-chip" data-filter="waiting" onclick="filterTickets('waiting', this)">Waiting</button>
                        <button class="filter-chip" data-filter="resolved" onclick="filterTickets('resolved', this)">Resolved</button>
                        <button class="filter-chip" data-filter="closed" onclick="filterTickets('closed', this)">Closed</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: All Tickets (from stats bar click) ===== -->
        <div id="allTicketsScreen" class="hidden">
            <div class="back-row">
                <button class="btn-back" onclick="goHome()">‚Üê Back to overview</button>
            </div>
            <div class="tickets-header">
                <h2 id="allTicketsTitle" data-i18n="all_tickets_title">All Tickets</h2>
            </div>
            <div id="allTicketsDrilldownBanner" class="desktop-insight-empty" style="display:none;margin-bottom:10px"></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
                <select class="form-select" id="atFilterStatus" onchange="filterAllTickets()" style="width:auto;min-width:130px;font-size:13px;padding:6px 10px">
                    <option value="unassigned">Unassigned Tickets</option>
                    <option value="all">All Statuses</option>
                    <option value="assigned">Assigned</option>
                    <option value="inprogress">In Progress</option>
                    <option value="waiting">Waiting</option>
                    <option value="resolved">Resolved</option>
                    <option value="closed">Closed</option>
                </select>
                <select class="form-select" id="atFilterType" onchange="filterAllTickets()" style="width:auto;min-width:130px;font-size:13px;padding:6px 10px">
                    <option value="">All Store Types</option>
                    <option value="fastfood">Fast Food</option>
                    <option value="cstore">C-Store</option>
                    <option value="carwash">Car Wash</option>
                </select>
                <select class="form-select" id="atFilterStore" onchange="filterAllTickets()" style="width:auto;min-width:160px;font-size:13px;padding:6px 10px">
                    <option value="">All Stores</option>
                </select>
            </div>
            <div class="tickets-list" id="allTicketsList"></div>
        </div>

        <!-- ===== SCREEN: Admin Panel ===== -->
        <div id="adminScreen" class="hidden">
            <div class="back-row">
                <button class="btn btn-ghost" onclick="goBackFromAdmin()">‚Üê Back</button>
                <h2 data-i18n="admin_panel">Admin Panel</h2>
            </div>

            <!-- Pending Users -->
            <div class="admin-section">
                <div class="admin-section-header">
                    <h3>üïê Pending Approval <span id="pendingCount" style="color:var(--text-muted);font-weight:400;font-size:13px"></span></h3>
                </div>
                <div class="admin-section-body" id="pendingList">
                    <div class="empty-state">No pending users</div>
                </div>
            </div>

            <!-- Active Users -->
            <div class="admin-section">
                <div class="admin-section-header">
                    <h3>üë• Active Users <span id="activeCount" style="color:var(--text-muted);font-weight:400;font-size:13px"></span></h3>
                </div>
                <div class="admin-section-body" id="activeUsersList">
                    <div class="empty-state">Loading...</div>
                </div>
            </div>

            <!-- Add User -->
            <div class="admin-section">
                <div class="admin-section-header">
                    <h3>‚ûï Add New User</h3>
                </div>
                <div class="admin-section-body" id="addUserSection">
                    <div style="display:grid;gap:12px">
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Name</label>
                            <input class="form-input" type="text" id="newUserName" placeholder="Full name">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Email</label>
                            <input class="form-input" type="email" id="newUserEmail" placeholder="user@dossaniparadise.com">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="newUserRole">
                                <option value="">Choose role...</option>
                                <option value="Admin">Admin</option>
                                <option value="Area Coach">Area Coach</option>
                                <option value="Manager">Manager</option>
                                <option value="Technician">Technician</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Ticket Categories (for notification routing)</label>
                            <div id="newUserCats" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px"></div>
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Store Access <button class="btn btn-ghost" style="font-size:11px;padding:2px 8px;margin-left:8px" onclick="toggleAllNewUserStores()">Select All / None</button></label>
                            <div id="newUserStores" class="store-cb-grid"></div>
                        </div>
                        <button class="btn btn-primary" onclick="addNewUser()">Add User to System</button>
                    </div>
                </div>
            </div>

            <!-- Database Cleanup -->
            <div class="admin-section">
                <div class="admin-section-header">
                    <h3>üßπ Database Cleanup</h3>
                </div>
                <div class="admin-section-body" id="cleanupSection">
                    <p style="font-size:13px;color:var(--text-mid);margin-bottom:12px">Remove old data nodes from the previous app version that are no longer needed.</p>
                    <div id="cleanupNodes" style="margin-bottom:12px"></div>
                    <button class="btn btn-secondary" onclick="scanOldNodes()" id="scanBtn">Scan for old data</button>
                </div>
            </div>

            <!-- Vendor Management -->
            <div class="admin-section" id="vendorSection">
                <div class="admin-section-header">
                    <h3>üîß Approved Vendors</h3>
                </div>
                <div class="admin-section-body" id="vendorList">
                    <p style="font-size:13px;color:var(--text-mid);margin-bottom:12px">Manage third-party vendors available for ticket assignment.</p>
                    <div id="vendorRows"></div>
                    <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:12px">
                        <h4 style="font-size:13px;margin-bottom:8px;color:var(--text)">Add Vendor</h4>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                            <input class="form-input" id="newVendorName" placeholder="Vendor name">
                            <input class="form-input" id="newVendorAreas" placeholder="Service areas (e.g. East TX)">
                        </div>
                        <div style="margin-top:6px;display:flex;gap:6px;align-items:center;flex-wrap:wrap">
                            <span style="font-size:12px;color:var(--text-muted)">Categories:</span>
                            <div id="newVendorCats" style="display:flex;gap:4px;flex-wrap:wrap"></div>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="addVendor()" style="margin-top:8px">Add Vendor</button>
                    </div>
                </div>
            </div>

            <!-- Notification Routing -->
            <div class="admin-section">
                <div class="admin-section-header">
                    <h3>üîî Notification Routing</h3>
                </div>
                <div class="admin-section-body" id="notifySection">
                    <p style="font-size:13px;color:var(--text-mid);margin-bottom:14px">Set up to 3 users per category. These users will see matching tickets in their notification bell when they log in.</p>
                    <div id="notifyGrid"></div>
                    <button class="btn btn-primary" onclick="saveNotifyRouting()" style="margin-top:12px">Save Routing</button>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Clock Out Modal (for techs) -->
<div class="modal-overlay" id="clockOutModal" onclick="if(event.target===this)document.getElementById('clockOutModal').classList.remove('open')">
    <div class="modal-content" style="max-width:480px">
        <div class="modal-header">
            <h3>üîß Clock Out</h3>
            <button class="modal-close" onclick="document.getElementById('clockOutModal').classList.remove('open')">‚úï</button>
        </div>
        <div class="modal-body" style="padding:16px">
            <div id="clockOutInfo" style="margin-bottom:12px"></div>
            <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">New Status</label>
                <div class="status-select-grid" id="clockOutStatusGrid"></div>
            </div>
            <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="clockOutNotes" placeholder="What did you do? What's the current state?" style="min-height:80px"></textarea>
            </div>
            <div class="form-group" style="margin-bottom:12px">
                <label style="font-size:12px;color:var(--text-muted);cursor:pointer;display:inline-flex;align-items:center;gap:4px">
                    üì∑ <span>Attach photos (up to 3)</span>
                    <input type="file" id="clockOutPhotoInput" accept="image/*" multiple style="display:none" onchange="handleClockOutPhotos(this)">
                </label>
                <div id="clockOutPhotoPreview" style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap"></div>
            </div>
            <button class="btn btn-primary" onclick="confirmClockOut()" id="clockOutBtn" style="width:100%">Complete Clock Out</button>
        </div>
    </div>
</div>

<!-- Ticket Detail Modal -->
<div class="modal-overlay" id="ticketModal" onclick="if(event.target===this)closeModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTicketId">Ticket #---</h3>
            <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Populated by JS -->
        </div>
    </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <img id="lightboxImg" src="" alt="Photo">
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Data files + Application logic (modular build v5.3.1) -->
<script src="stores-data.js"></script>
<script src="users-data.js"></script>
<script src="app.js"></script>


<!-- Version Footer -->
<div id="versionFooter" style="position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.03);border-top:1px solid rgba(0,0,0,0.06);padding:2px 8px;font-size:10px;color:#94a3b8;display:flex;justify-content:center;gap:16px;z-index:1;font-family:'JetBrains Mono',monospace;letter-spacing:0.3px">
    <span>R&M Tracker v5.3.1</span>
    <span>Build 5.3.1</span>
</div>

</body>
</html>
