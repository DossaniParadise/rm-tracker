<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossani Paradise R&M Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
/* ============================================================
   DOSSANI PARADISE R&M TRACKER - COMPLETE STYLES
   ============================================================ */

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --bg: #f5f3ef;
    --card: #ffffff;
    --primary: #2563eb;
    --primary-light: #eff4ff;
    --primary-hover: #1d4ed8;
    --accent: #d97706;
    --accent-light: #fef9ee;
    --danger: #dc2626;
    --danger-light: #fef2f2;
    --warning: #ea580c;
    --warning-light: #fff7ed;
    --info: #2563eb;
    --info-light: #eff4ff;
    --text: #1e293b;
    --text-mid: #475569;
    --text-muted: #94a3b8;
    --border: #e2e8f0;
    --border-light: #f1f5f9;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-lg: 0 10px 25px rgba(0,0,0,0.08);
    --radius: 10px;
    --radius-lg: 14px;

    /* Status colors */
    --status-open: #dc2626;
    --status-assigned: #7c3aed;
    --status-inprogress: #2563eb;
    --status-waiting: #d97706;
    --status-resolved: #059669;
    --status-closed: #6b7280;
}
[data-theme="dark"] {
    --bg: #0f1419;
    --card: #1a1f2e;
    --primary: #5b9cf6;
    --primary-light: rgba(91,156,246,0.12);
    --primary-hover: #4a8ae0;
    --accent: #f0b429;
    --accent-light: rgba(240,180,41,0.1);
    --danger: #f87171;
    --danger-light: rgba(248,113,113,0.1);
    --warning: #fb923c;
    --warning-light: rgba(251,146,60,0.1);
    --info: #5b9cf6;
    --info-light: rgba(91,156,246,0.1);
    --text: #e2e8f0;
    --text-mid: #94a3b8;
    --text-muted: #64748b;
    --border: #2a3040;
    --border-light: #1e2433;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
    --shadow: 0 1px 3px rgba(0,0,0,0.3);
    --shadow-lg: 0 10px 25px rgba(0,0,0,0.3);
    --status-open: #f87171;
    --status-assigned: #a78bfa;
    --status-inprogress: #5b9cf6;
    --status-waiting: #f0b429;
    --status-resolved: #34d399;
    --status-closed: #64748b;
}
[data-theme="dark"] .brand-pill-icon { background: #252b3b; }
[data-theme="dark"] .brand-pill { background: #1a1f2e; border-color: var(--border); color: var(--text); }
[data-theme="dark"] .brand-pill:hover { border-color: var(--primary); }
[data-theme="dark"] .brand-pill.active { background: rgba(91,156,246,0.15); border-color: var(--primary); color: var(--primary); }
[data-theme="dark"] .store-card { background: var(--card); }
[data-theme="dark"] .form-label { color: var(--text-mid); }
[data-theme="dark"] .store-card-header h2 { color: var(--text); }
[data-theme="dark"] .store-card-header p { color: var(--text-muted); }
[data-theme="dark"] .action-card { background: #141821; border-color: var(--border); }
[data-theme="dark"] .action-card:hover { border-color: var(--primary); background: #1a1f2e; }
[data-theme="dark"] .action-title { color: var(--text); }
[data-theme="dark"] .action-desc { color: var(--text-muted); }
[data-theme="dark"] .admin-section { border-color: var(--border); }
[data-theme="dark"] .admin-section-header { background: #141821; border-color: var(--border); }
[data-theme="dark"] .admin-section-body { background: var(--card); }
[data-theme="dark"] .form-input,
[data-theme="dark"] .form-select,
[data-theme="dark"] .form-textarea { background: #141821; color: var(--text); border-color: var(--border); color-scheme: dark; }
[data-theme="dark"] .form-select option { background: #1a1f2e; color: #e2e8f0; }
[data-theme="dark"] .filter-chip { background: #1a1f2e; color: var(--text-mid); border-color: var(--border); }
[data-theme="dark"] .filter-chip.active { background: var(--primary); color: #fff; }
[data-theme="dark"] .btn-secondary { background: #1a1f2e; color: var(--text); border-color: var(--border); }
[data-theme="dark"] .btn-back, [data-theme="dark"] .btn-ghost { color: var(--text-mid); }
[data-theme="dark"] .priority-label, [data-theme="dark"] .priority-desc { color: var(--text); }
[data-theme="dark"] .priority-btn { background: #141821; border-color: var(--border); }
[data-theme="dark"] .priority-btn:hover { border-color: var(--text-muted); }
[data-theme="dark"] .category-btn { background: #141821; border-color: var(--border); }
[data-theme="dark"] .category-btn .cat-label { color: var(--text-mid); }
[data-theme="dark"] .category-btn.selected .cat-label { color: var(--primary); }
[data-theme="dark"] .ticket-card-desc { color: var(--text); }
[data-theme="dark"] .ticket-card-meta { color: var(--text-mid); }
[data-theme="dark"] .ticket-id { color: var(--text-muted); }

[data-theme="dark"] .notify-panel { background: #1a1f2e; border-color: var(--border); }
[data-theme="dark"] .notify-panel-header { border-color: var(--border); }
[data-theme="dark"] .notify-item { border-color: var(--border); }
[data-theme="dark"] .notify-item:hover { background: #141821; }
[data-theme="dark"] .notify-item-title { color: var(--text); }
[data-theme="dark"] .s-open, [data-theme="dark"] .ticket-status { color: var(--text); }
[data-theme="dark"] .toast.success { background: rgba(52,211,153,0.15); color: #34d399; border: 1px solid rgba(52,211,153,0.3); }
[data-theme="dark"] .toast.error { background: rgba(248,113,113,0.15); color: #f87171; border: 1px solid rgba(248,113,113,0.3); }
[data-theme="dark"] .pending-card { background: #141821; }
[data-theme="dark"] .leaflet-popup-content-wrapper { background: #1a1f2e !important; }
[data-theme="dark"] .leaflet-popup-tip { background: #1a1f2e !important; }

[data-theme="dark"] .login-container { background: var(--bg); }
[data-theme="dark"] .login-card { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .login-card input { background: #141821; color: var(--text); border-color: var(--border); }

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    min-height: 100vh;
    font-size: 14px;
}

/* ---- Utility ---- */
.hidden { display: none !important; }

/* ---- Login Screen ---- */
.login-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background: var(--bg);
    position: relative;
    overflow: hidden;
}

.login-container::before {
    content: '';
    position: absolute;
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(37,99,235,0.04) 0%, transparent 70%);
    top: -200px;
    right: -200px;
    border-radius: 50%;
}

.login-card {
    background: var(--card);
    border-radius: 20px;
    box-shadow: var(--shadow-lg);
    padding: 48px 40px;
    max-width: 420px;
    width: 100%;
    text-align: center;
    position: relative;
    z-index: 1;
}

.login-brand {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: var(--primary-light);
    padding: 8px 18px;
    border-radius: 30px;
    margin-bottom: 24px;
    font-weight: 600;
    font-size: 13px;
    color: var(--primary);
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.login-title {
    font-size: 26px;
    font-weight: 700;
    margin-bottom: 6px;
    color: var(--text);
}

.login-subtitle {
    color: var(--text-muted);
    margin-bottom: 32px;
    font-size: 15px;
}

.form-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 15px;
    font-family: inherit;
    transition: border-color 0.2s;
    background: #fafaf8;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    background: #fff;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 13px 24px;
    border: none;
    border-radius: var(--radius);
    font-size: 15px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-full { width: 100%; }

.btn-primary {
    background: var(--primary);
    color: #fff;
}
.btn-primary:hover {
    background: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(26,95,58,0.3);
}

.btn-secondary {
    background: var(--border-light);
    color: var(--text);
}
.btn-secondary:hover { background: var(--border); }

.btn-accent {
    background: var(--accent);
    color: #fff;
}
.btn-accent:hover { background: #c49515; }

.btn-danger {
    background: var(--danger);
    color: #fff;
}
.btn-danger:hover { background: #a93226; }

.btn-ghost {
    background: transparent;
    color: var(--text-mid);
    border: 1px solid var(--border);
}
.btn-ghost:hover { background: var(--border-light); }

.btn-sm {
    padding: 8px 14px;
    font-size: 13px;
}

.error-message {
    background: var(--danger-light);
    color: var(--danger);
    padding: 12px 16px;
    border-radius: var(--radius);
    margin-top: 16px;
    font-size: 14px;
    border: 1px solid rgba(248,113,113,0.2);
}

/* ---- App Shell ---- */
.app-container {
    display: none;
    min-height: 100vh;
    flex-direction: column;
}


/* Theme & Language Toggle */
.theme-toggle {
    background: none;
    border: 1px solid var(--border);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
    font-family: inherit;
    font-weight: 700;
    color: var(--text-mid);
}
.theme-toggle:hover { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }
/* Header */
.app-header {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 64px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-sm);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.header-logo {
    font-size: 20px;
}

.header-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--primary);
}

.header-right {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
}

.user-badge {
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-avatar {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    background: var(--primary-light);
    color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 13px;
}

.user-meta { line-height: 1.3; }

.user-name {
    font-size: 13px;
    font-weight: 600;
}

.user-role-tag {
    font-size: 11px;
    color: var(--text-muted);
}

.btn-logout {
    background: none;
    border: 1px solid var(--border);
    padding: 7px 14px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 13px;
    font-family: inherit;
    color: var(--text-mid);
    transition: all 0.2s;
}
.btn-logout:hover { background: var(--danger-light); color: var(--danger); border-color: var(--danger); }

/* Content */
.app-content {
    flex: 1;
    padding: clamp(8px, 2.5vw, 24px);
    max-width: 960px;
    margin: 0 auto;
    width: 100%;
}

/* ---- Store Selection Card ---- */
.store-card {
    background: var(--card);
    border-radius: var(--radius-lg);
    padding: clamp(14px, 3vw, 32px);
    box-shadow: var(--shadow);
    margin-bottom: 16px;
}

.store-card-header {
    margin-bottom: 24px;
}

.store-card-header h2 {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 4px;
}

.store-card-header p {
    color: var(--text-muted);
    font-size: 14px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 0;
}

.form-group { margin-bottom: 16px; }

.form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    font-size: 13px;
    color: var(--text-mid);
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.form-select {
    width: 100%;
    padding: 12px 14px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 15px;
    font-family: inherit;
    background: #fafaf8;
    cursor: pointer;
    transition: all 0.2s;
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23475569' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
}

.form-select:focus {
    outline: none;
    border-color: var(--primary);
    background-color: #fff;
}

/* ---- Action Cards ---- */
.action-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-top: 20px;
}

.action-card {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 28px 20px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.action-card::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary);
    transform: scaleX(0);
    transition: transform 0.2s;
}

.action-card:hover {
    border-color: var(--primary);
    transform: translateY(-3px);
    box-shadow: var(--shadow);
}

.action-card:hover::after { transform: scaleX(1); }

.action-icon {
    font-size: 36px;
    margin-bottom: 10px;
}

.action-title {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 4px;
}

.action-desc {
    color: var(--text-muted);
    font-size: 13px;
}

/* ---- Back Button ---- */
.back-row {
    margin-bottom: 20px;
}

.btn-back {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: none;
    color: var(--text-mid);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    padding: 6px 2px;
    font-family: inherit;
}
.btn-back:hover { color: var(--primary); }

/* ============================================================
   NEW ISSUE FORM
   ============================================================ */
.issue-form-card {
    background: var(--card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.issue-form-header {
    background: var(--primary);
    color: #fff;
    padding: 24px 32px;
}

.issue-form-header h2 {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 2px;
}

.issue-form-header p {
    font-size: 14px;
    opacity: 0.8;
}

.issue-form-body {
    padding: 28px 32px 32px;
}

.form-textarea {
    width: 100%;
    padding: 12px 14px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 15px;
    font-family: inherit;
    resize: vertical;
    min-height: 100px;
    background: #fafaf8;
    transition: border-color 0.2s;
    line-height: 1.5;
}

.form-textarea:focus {
    outline: none;
    border-color: var(--primary);
    background: #fff;
}

/* Category Picker */
.category-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.category-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 14px 10px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--border-light);
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
    min-height: 80px;
}

.category-btn:hover {
    border-color: var(--primary);
    background: var(--primary-light);
}

.category-btn.selected {
    border-color: var(--primary);
    background: var(--primary-light);
    box-shadow: 0 0 0 1px var(--primary);
}

.category-btn .cat-icon { font-size: 22px; display: flex; align-items: center; justify-content: center; height: 28px; }

.category-btn .cat-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-mid);
    text-align: center;
}

.category-btn.selected .cat-label { color: var(--primary); }

/* Photo Upload */
.photo-upload-area {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 28px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #fafaf8;
    position: relative;
}

.photo-upload-area:hover {
    border-color: var(--primary);
    background: var(--primary-light);
}

.photo-upload-area.has-photos {
    border-style: solid;
    border-color: var(--primary);
    background: var(--primary-light);
}

.upload-icon { font-size: 32px; margin-bottom: 8px; }

.upload-text {
    font-size: 14px;
    color: var(--text-mid);
    font-weight: 500;
}

.upload-hint {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}

.photo-preview-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 14px;
}

.photo-preview {
    position: relative;
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid var(--border);
}

.photo-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.photo-remove {
    position: absolute;
    top: 2px;
    right: 2px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
}

/* Priority Selector */
.priority-options {
    display: flex;
    gap: 10px;
}

.priority-btn {
    flex: 1;
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--border-light);
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
    font-family: inherit;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.priority-btn:hover { border-color: var(--text-muted); }

.priority-btn.selected { box-shadow: 0 0 0 1px currentColor; }
.priority-btn[data-loc].selected { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

.priority-btn.p-routine { }
.priority-btn.p-routine.selected { border-color: var(--info); color: var(--info); background: var(--info-light); }

.priority-btn.p-urgent { }
.priority-btn.p-urgent.selected { border-color: var(--warning); color: var(--warning); background: var(--warning-light); }

.priority-btn.p-emergency { }
.priority-btn.p-emergency.selected { border-color: var(--danger); color: var(--danger); background: var(--danger-light); }

.priority-label {
    font-size: 13px;
    font-weight: 700;
    display: block;
    margin-top: 4px;
}
.priority-desc {
    font-size: 10px;
    color: var(--text-muted);
    display: block;
    margin-top: 1px;
    font-weight: 400;
}
.priority-btn.selected .priority-desc { color: inherit; opacity: 0.7; }

.priority-icon { font-size: 20px; display: flex; align-items: center; justify-content: center; height: 24px; }

.form-actions {
    display: flex;
    gap: 12px;
    margin-top: 28px;
    padding-top: 20px;
    border-top: 1px solid var(--border-light);
}

.form-actions .btn { flex: 1; }

/* ============================================================
   EXISTING ISSUES / TICKET LIST
   ============================================================ */
.tickets-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.tickets-header h2 {
    font-size: 20px;
    font-weight: 700;
}

.ticket-filters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 18px;
}

.filter-chip {
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 20px;
    background: var(--card);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
    color: var(--text-mid);
}

.filter-chip:hover { border-color: var(--primary); color: var(--primary); }
.filter-chip.active { background: var(--primary); color: #fff; border-color: var(--primary); }

.tickets-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ticket-card {
    background: var(--card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    overflow: hidden;
    transition: all 0.15s;
    cursor: pointer;
}

.ticket-card:hover {
    box-shadow: var(--shadow);
    transform: translateY(-1px);
}

/* All Tickets view card layout */
.ticket-card-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}
.ticket-card-desc {
    font-size: 14px;
    color: var(--text);
    margin-bottom: 6px;
    line-height: 1.4;
}
.ticket-card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 12px;
    color: var(--text-mid);
    align-items: center;
}
.ticket-card-meta span { white-space: nowrap; }

/* All tickets card needs padding since it doesn't use ticket-card-inner */
.ticket-card > .ticket-card-top:first-child {
    padding: 16px 18px 0;
}
.ticket-card > .ticket-card-desc {
    padding: 0 18px;
}
.ticket-card > .ticket-card-meta {
    padding: 0 18px 14px;
}

.ticket-card-inner {
    padding: 18px 22px;
    display: flex;
    gap: 16px;
    align-items: flex-start;
}

.ticket-status-bar {
    width: 4px;
    min-height: 60px;
    border-radius: 4px;
    flex-shrink: 0;
    align-self: stretch;
}

.ticket-body { flex: 1; min-width: 0; }

.ticket-top-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 6px;
}

.ticket-id {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--text-muted);
}

.ticket-status-badge {
    font-size: 11px;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    white-space: nowrap;
}

.status-open { background: #fef2f2; color: var(--status-open); }
.status-assigned { background: #f5f3ff; color: var(--status-assigned); }
.status-inprogress { background: #eff4ff; color: var(--status-inprogress); }
.status-waiting { background: #fef9ee; color: var(--status-waiting); }
.status-resolved { background: #ecfdf5; color: var(--status-resolved); }
.status-closed { background: #f1f5f9; color: var(--status-closed); }

.ticket-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 4px;
    line-height: 1.4;
}

.ticket-meta {
    display: flex;
    gap: 14px;
    font-size: 12px;
    color: var(--text-muted);
    flex-wrap: wrap;
}

.ticket-meta span {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.priority-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
}

.priority-dot.routine { background: var(--info); }
.priority-dot.urgent { background: var(--warning); }
.priority-dot.emergency { background: var(--danger); }

/* ============================================================
   TICKET DETAIL / MODAL
   ============================================================ */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s;
}

.modal-overlay.open {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: var(--card);
    border-radius: var(--radius-lg);
    max-width: 640px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    transform: translateY(10px);
    transition: transform 0.2s;
}

.modal-overlay.open .modal-content { transform: translateY(0); }

.modal-header {
    padding: 22px 28px;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: var(--card);
    z-index: 1;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.modal-header h3 { font-size: 17px; font-weight: 700; }

.modal-close {
    background: none;
    border: none;
    font-size: 22px;
    cursor: pointer;
    color: var(--text-muted);
    padding: 4px;
    line-height: 1;
}
.modal-close:hover { color: var(--text); }

.modal-body { padding: 24px 28px; }

.detail-section {
    margin-bottom: 22px;
}

.detail-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
}

.detail-value {
    user-select: text;
    -webkit-user-select: text;
    font-size: 15px;
    line-height: 1.5;
}

.detail-photos {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.detail-photo {
    width: 100px;
    height: 100px;
    border-radius: 8px;
    object-fit: cover;
    cursor: pointer;
    border: 1px solid var(--border);
    transition: transform 0.15s;
}

.detail-photo:hover { transform: scale(1.05); }

/* Status update section in modal */
.status-update-section {
    background: var(--border-light);
    border-radius: var(--radius);
    padding: 18px;
    margin-top: 16px;
}

.status-update-section h4 {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 12px;
}

.status-select-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 12px;
}

.status-option {
    padding: 8px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--card);
    cursor: pointer;
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    font-family: inherit;
    transition: all 0.15s;
}

.status-option:hover { border-color: var(--text-muted); }
.status-option.active { border-color: var(--primary); background: var(--primary-light); }

/* Activity log */
.activity-log {
    margin-top: 20px;
    border-top: 1px solid var(--border-light);
    padding-top: 18px;
}

.activity-log h4 {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 12px;
}

.activity-item {
    display: flex;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-light);
    font-size: 13px;
}

.activity-item:last-child { border-bottom: none; }

.activity-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--border);
    margin-top: 6px;
    flex-shrink: 0;
}

.activity-text { color: var(--text-mid); line-height: 1.5; }
.activity-text strong { color: var(--text); }
.activity-time { color: var(--text-muted); font-size: 11px; display: block; margin-top: 2px; }

/* ---- Empty State ---- */
.empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--text-muted);
}

.empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; }
.empty-state h3 { font-size: 17px; color: var(--text-mid); margin-bottom: 6px; }
.empty-state p { font-size: 14px; }

/* ---- Toast ---- */
.toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--text);
    color: #fff;
    padding: 12px 24px;
    border-radius: var(--radius);
    font-size: 14px;
    font-weight: 500;
    box-shadow: var(--shadow-lg);
    z-index: 300;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
}

.toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

.toast.success { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
.toast.error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }

/* ---- Loading spinner ---- */
.spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2.5px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 0.7s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.spinner-dark {
    border-color: rgba(0,0,0,0.1);
    border-top-color: var(--primary);
}

/* ---- Image lightbox ---- */
.lightbox {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 400;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s;
    cursor: pointer;
}

.lightbox.open { opacity: 1; visibility: visible; }

.lightbox img {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 8px;
}

/* ---- Responsive ---- */

/* Tablet */
@media (max-width: 900px) {
    .app-content { padding: 12px; }
    .store-card { padding: 16px; }
    #overviewMap { height: 300px; }
    .map-header { padding: 10px 14px; }
    .map-stats-bar { padding: 8px 14px; }
    .header-right { gap: 8px; }
}

/* Mobile */
@media (max-width: 600px) {
    .app-header { padding: 0 10px; height: 50px; }
    .header-title { font-size: 13px; }
    .theme-toggle { width: 28px; height: 28px; font-size: 14px; }
    .user-badge .user-meta { display: none; }
    .user-avatar { width: 28px; height: 28px; font-size: 11px; }
    .admin-btn { font-size: 11px; padding: 4px 8px; }
    .notify-panel { right: 4px; width: calc(100vw - 8px); top: 50px; max-height: 60vh; }
    .notify-item { padding: 10px 12px; }
    .btn-logout { font-size: 11px; padding: 4px 10px; }
    .app-content { padding: 8px; }
    .store-card { padding: 14px; }
    .store-card h2 { font-size: 16px; }
    .store-card-header p { font-size: 12px; }
    .brand-pill { padding: 8px 14px 8px 8px; font-size: 13px; }
    .brand-pill-icon { width: 24px; height: 24px; border-radius: 6px; }
    .brand-pill-icon img { width: 18px; height: 18px; }
    .form-row { grid-template-columns: 1fr; }
    .form-label { font-size: 11px; }
    .form-select, .form-input { font-size: 13px; padding: 8px 10px; }
    .action-grid { grid-template-columns: 1fr; gap: 8px; }
    .action-card { padding: 16px; }
    .action-icon { font-size: 24px; }
    .action-title { font-size: 14px; }
    .action-desc { font-size: 11px; }
    #overviewMap { height: 250px; }
    .map-header { padding: 8px 12px; }
    .map-header h2 { font-size: 14px; }
    .map-legend { font-size: 10px; gap: 8px; }
    .map-stats-bar { padding: 8px 12px; gap: 10px; }
    .map-stats-bar .mstat strong { font-size: 14px; }
    .map-stats-bar .mstat { font-size: 11px; }
    .category-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .category-btn { padding: 10px 6px; }
    .cat-icon { font-size: 20px; }
    .cat-label { font-size: 11px; }
    .priority-options { flex-direction: column; gap: 6px; }
    .priority-btn { padding: 10px; flex-direction: row; gap: 10px; }
    .priority-icon { font-size: 18px; }
    .priority-label { font-size: 13px; margin-top: 0; }
    .priority-desc { display: inline; margin-top: 0; margin-left: 4px; }
    .issue-form-body { padding: 14px; }
    .issue-form-header { padding: 14px; }
    .issue-form-header h2 { font-size: 16px; }
    .photo-upload-area { padding: 16px; }
    .form-actions { flex-direction: column; }
    .form-actions .btn { width: 100%; }
    .status-select-grid { grid-template-columns: repeat(2, 1fr); }
    .modal-content { max-width: 100%; margin: 0 8px; max-height: 90vh; }
    .modal-body { padding: 14px; }
    .modal-header { padding: 14px; }
    .modal-header h3 { font-size: 14px; }
    .ticket-card-inner { padding: 12px; }
    .ticket-card-desc { font-size: 13px; }
    .ticket-card-meta { font-size: 11px; }
    .ticket-id { font-size: 11px; }
    .tickets-header { flex-direction: column; align-items: flex-start; gap: 8px; }
    .tickets-header h2 { font-size: 16px; }
    .ticket-filters { gap: 4px; }
    .filter-chip { font-size: 11px; padding: 4px 10px; }
    .back-row { margin-bottom: 8px; }
    .btn-back { font-size: 12px; }
    .admin-section-header { padding: 12px 14px; }
    .admin-section-body { padding: 12px 14px; }
    .admin-section-header h3 { font-size: 13px; }
    .pending-form { grid-template-columns: 1fr; }
    .user-row { flex-wrap: wrap; gap: 8px; }
    .user-row-actions { width: 100%; justify-content: flex-end; }
    .admin-modal { padding: 16px 8px 8px; }
    .modal-card { padding: 16px; max-width: 100%; }
    .modal-card h3 { font-size: 14px; }
    .leaflet-popup-content-wrapper { max-width: 240px !important; }
    .mp-btns { flex-direction: column; gap: 4px; }
    .mp-btn { font-size: 11px; padding: 5px 8px; }
}

/* Extra small phones */
@media (max-width: 380px) {
    .brand-pill { padding: 6px 10px 6px 6px; font-size: 12px; gap: 5px; }
    .brand-pill-icon { width: 20px; height: 20px; }
    .brand-pill-icon img { width: 16px; height: 16px; }
    .store-card { padding: 10px; }
    .app-content { padding: 6px; }
    #overviewMap { height: 200px; }
}
    
/* ============================================================
   MAP OVERVIEW
   ============================================================ */
#mapOverview { margin-bottom: 20px; }
.map-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    overflow: hidden;
}
.map-header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
}
.map-header h2 { font-size: 16px; font-weight: 700; }
.map-legend {
    display: flex;
    gap: 12px;
    font-size: 11px;
    color: var(--text-mid);
}
.map-legend span {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}
.map-legend .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
}
.dot-green { background: #34d399; }
.dot-yellow { background: #fbbf24; }
.dot-red { background: #f87171; }
#overviewMap {
    width: 100%;
    height: 420px;
    background: var(--bg);
}
.map-stats-bar {
    padding: 12px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 16px;
    font-size: 12px;
    color: var(--text-mid);
    flex-wrap: wrap;
}
.map-stats-bar .mstat {
    display: flex;
    align-items: center;
    gap: 5px;
}
.map-stats-bar .mstat strong {
    color: var(--text);
    font-size: 15px;
}
.map-stats-bar .mstat[style*="cursor"] { padding: 4px 8px; border-radius: 6px; }
.map-stats-bar .mstat[style*="cursor"]:hover { background: var(--primary-light); }

/* Leaflet dark overrides */
.leaflet-popup-content-wrapper {
    background: var(--card) !important;
    color: var(--text) !important;
    border: 1px solid var(--border) !important;
    border-radius: 10px !important;
    font-family: 'Inter', sans-serif !important;
    box-shadow: var(--shadow-lg) !important;
}
.leaflet-popup-content { margin: 0 !important; }
.leaflet-popup-tip { background: #fff !important; }
.map-popup { padding: 14px; }
.map-popup .mp-name { font-size: 14px; font-weight: 700; margin-bottom: 3px; }
.map-popup .mp-addr { font-size: 12px; color: var(--text-mid); margin-bottom: 8px; cursor: pointer; }
.map-popup .mp-addr:hover { color: var(--primary); }
.map-popup .mp-stats { display: flex; gap: 10px; margin-bottom: 10px; font-size: 12px; }
.map-popup .mp-stat { text-align: center; }
.map-popup .mp-stat strong { display: block; font-size: 18px; }
.map-popup .mp-btns { display: flex; gap: 6px; }
.map-popup .mp-btn {
    flex: 1;
    padding: 7px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--primary-light);
    color: var(--primary);
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    font-family: inherit;
}
.map-popup .mp-btn:hover { background: var(--primary); color: #fff; }

/* map mobile handled in main responsive section */

/* ============================================================
   BRAND PILL BUTTONS
   ============================================================ */
.brand-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #fff;
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 10px 20px 10px 12px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
}
.brand-pill:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow);
}
.brand-pill.active {
    border-color: var(--primary);
    background: var(--primary-light);
    color: var(--primary);
}
.brand-pill-icon {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    background: #f8f8f8;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}
.brand-pill-icon img {
    width: 22px;
    height: 22px;
    object-fit: contain;
}

/* ============================================================
   ADMIN PANEL
   ============================================================ */
.admin-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text-mid);
    cursor: pointer;
    padding: 6px 10px;
    font-size: 13px;
    font-family: inherit;
    transition: all 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}
.admin-btn:hover { color: var(--primary); border-color: var(--primary); }
.admin-btn .badge {
    background: var(--danger);
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
}

#adminScreen .admin-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    margin-bottom: 16px;
    overflow: hidden;
}
#adminScreen .admin-section-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#adminScreen .admin-section-header h3 {
    font-size: 15px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
}
#adminScreen .admin-section-body { padding: 16px 20px; }

.pending-card {
    background: var(--border-light);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 10px;
}
.pending-card:last-child { margin-bottom: 0; }
.pending-email { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
.pending-time { font-size: 11px; color: var(--text-muted); margin-bottom: 12px; }
.pending-form { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
.pending-form .full { grid-column: 1 / -1; }
.pending-form input, .pending-form select {
    padding: 8px 10px;
    background: #fafafa;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 13px;
    font-family: inherit;
}
.pending-form select { cursor: pointer; }
.pending-actions { display: flex; gap: 6px; }
.pending-actions .btn { font-size: 12px; padding: 7px 14px; }

.user-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-light);
}
.user-row:last-child { border-bottom: none; }
.user-row-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-light);
    color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    flex-shrink: 0;
}
.user-row-info { flex: 1; min-width: 0; }
.user-row-name { font-size: 13px; font-weight: 600; }
.user-row-email { font-size: 11px; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.user-row-role {
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 10px;
    flex-shrink: 0;
}
.user-row-role.admin { background: #eff4ff; color: var(--primary); }
.user-row-role.areacoach { background: #f5f3ff; color: #a78bfa; }
.user-row-role.manager { background: #ecfdf5; color: #34d399; }
.user-row-actions { display: flex; gap: 4px; flex-shrink: 0; }
.user-row-actions button {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-mid);
    cursor: pointer;
    padding: 4px 8px;
    font-size: 12px;
    font-family: inherit;
}
.user-row-actions button:hover { color: var(--primary); border-color: var(--primary); }
.user-row-actions button.del:hover { color: var(--danger); border-color: var(--danger); }

/* Notification Panel */
.notify-panel {
    position: fixed;
    top: 56px;
    right: 12px;
    width: 380px;
    max-width: calc(100vw - 24px);
    max-height: 70vh;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    z-index: 300;
    overflow: hidden;
    display: none;
}
.notify-panel.open { display: flex; flex-direction: column; }
.notify-panel-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 700;
    font-size: 14px;
}
.notify-panel-body {
    overflow-y: auto;
    flex: 1;
    max-height: calc(70vh - 50px);
}
.notify-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-light);
    cursor: pointer;
    transition: background 0.1s;
    font-size: 13px;
}
.notify-item:hover { background: var(--border-light); }
.notify-item-title { font-weight: 600; margin-bottom: 2px; color: var(--text); }
.notify-item-meta { font-size: 11px; color: var(--text-muted); display: flex; gap: 8px; flex-wrap: wrap; }
.notify-item .pri-urgent { color: #d97706; }
.notify-item .pri-emergency { color: #dc2626; font-weight: 700; }
.notify-empty { padding: 30px; text-align: center; color: var(--text-muted); font-size: 13px; }

/* Admin/dynamic modal overlay */
.admin-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 250;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 80px 20px 20px;
    overflow-y: auto;
}
.modal-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: 24px;
    max-width: 480px;
    width: 100%;
}
.modal-card h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
.modal-card .form-group { margin-bottom: 12px; }
.modal-card .modal-actions { display: flex; gap: 8px; margin-top: 16px; }

.empty-state {
    text-align: center;
    padding: 24px;
    color: var(--text-muted);
    font-size: 13px;
}

/* admin mobile handled in main responsive section */

</style>
</head>
<body>

<!-- ============================================================
     LOGIN SCREEN
     ============================================================ -->
<div class="login-container" id="loginScreen">
    <div class="login-card">
        <img src="logos/dpm-logo.png" alt="DPM" style="height:44px;margin-bottom:18px;object-fit:contain">
        <h1 class="login-title">R&amp;M Tracker</h1>
        <p class="login-subtitle">Dossani Paradise Management</p>

        <!-- Login Form -->
        <div id="loginForm">
            <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">
                Enter your email to receive a secure sign-in link.
            </p>
            <div class="form-group">
                <input
                    type="email"
                    id="loginEmail"
                    class="form-input"
                    placeholder="you@dossaniparadise.com"
                    autocomplete="email"
                >
            </div>
            <button class="btn btn-primary btn-full" onclick="sendSignInLink()" id="sendLinkBtn">
                Send Sign-In Link
            </button>
        </div>

        <!-- Email Sent Confirmation -->
        <div id="emailSentMessage" class="hidden" style="text-align: center;">
            <div style="font-size: 44px; margin-bottom: 12px;">üìß</div>
            <h3 style="margin-bottom: 6px; font-size: 18px;">Check your inbox</h3>
            <p style="color: var(--text-muted); margin-bottom: 14px; font-size: 14px;">
                We sent a sign-in link to<br>
                <strong id="sentToEmail" style="color: var(--text);"></strong>
            </p>
            <div style="background: #fef9ee; border: 1px solid #fde68a; border-radius: 8px; padding: 10px 14px; margin-bottom: 16px;">
                <p style="color: var(--accent); font-size: 13px;">
                    ‚ö†Ô∏è Check your <strong>spam/junk folder</strong> if you don't see it
                </p>
            </div>
            <button class="btn btn-ghost btn-full" onclick="resendEmail()">
                Send Another Link
            </button>
        </div>

        <div id="loginError" class="error-message hidden"></div>
    </div>
</div>

<!-- ============================================================
     MAIN APP
     ============================================================ -->
<div class="app-container" id="appContainer">

    <!-- Header -->
    <div class="app-header">
        <div class="header-left">
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle dark mode">üåô</button>
            <button class="theme-toggle" id="langToggle" onclick="toggleLang()" title="Espa√±ol / English">EN</button>
            <a class="header-logo" href="#" onclick="goHome();return false" style="text-decoration:none;display:flex;align-items:center;gap:8px;cursor:pointer"><img src="logos/dpm-icon.png" alt="DPM" style="height:24px;vertical-align:middle"><span class="header-title">R&amp;M Tracker</span></a>
        </div>
        <div class="header-right">
            <div class="user-badge">
                <div class="user-avatar" id="userAvatar">?</div>
                <div class="user-meta">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role-tag" id="userRole">...</div>
                </div>
            </div>
            <button class="admin-btn hidden" id="adminBtn" onclick="showAdminPanel()">‚öôÔ∏è <span class="badge hidden" id="pendingBadge">0</span></button>
            <button class="admin-btn hidden" id="notifyBtn" onclick="toggleNotifyPanel()" style="position:relative">üîî <span class="badge hidden" id="notifyBadge" style="background:#dc2626">0</span></button>
            <button class="admin-btn hidden" id="viewAsBtn" onclick="showViewAsModal()">üëÅ View As</button>
            <button class="btn-logout" onclick="logout()" data-i18n="sign_out">Sign Out</button>
        </div>
    </div>

    <!-- Notification Panel (dropdown) -->
    <div class="notify-panel" id="notifyPanel">
        <div class="notify-panel-header">
            <span data-i18n="notifications">Notifications</span>
            <button onclick="toggleNotifyPanel()" style="background:none;border:none;cursor:pointer;font-size:16px;color:var(--text-muted)">‚úï</button>
        </div>
        <div class="notify-panel-body" id="notifyPanelBody">
            <div class="notify-empty">Loading...</div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="app-content">

        <!-- ===== SCREEN: Store Selection ===== -->
        <div id="storeSelection">
            <div class="store-card">
                <div class="store-card-header">
                    <h2 data-i18n="select_store">Select Your Store</h2>
                    <p data-i18n="select_store_sub">Choose a location to report or check issues</p>
                </div>

                <!-- Brand buttons - clickable, trigger store type + map -->
                <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:12px">
                    <button onclick="selectBrand('all')" class="brand-pill hidden" id="brandPill-all">
                        <span class="brand-pill-icon" style="background:var(--primary);color:#fff;font-size:14px;font-weight:700">üìç</span>
                        <span>All Locations</span>
                    </button>
                    <button onclick="selectBrand('fastfood')" class="brand-pill" id="brandPill-fastfood">
                        <span class="brand-pill-icon"><img src="logos/bk-logo.png" alt=""></span>
                        <span>Fast Food</span>
                    </button>
                    <button onclick="selectBrand('cstore')" class="brand-pill" id="brandPill-cstore">
                        <span class="brand-pill-icon"><img src="logos/pqs-logo.png" alt=""></span>
                        <span>C-Store</span>
                    </button>
                    <button onclick="selectBrand('carwash')" class="brand-pill" id="brandPill-carwash">
                        <span class="brand-pill-icon"><img src="logos/cw-logo.png" alt=""></span>
                        <span>Car Wash</span>
                    </button>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="store_type">Store Type</label>
                        <select class="form-select" id="storeType" onchange="filterStores()">
                            <option value="">Choose type...</option>
                            <option value="all" class="admin-only-opt hidden">All Locations</option>
                            <option value="fastfood">Fast Food</option>
                            <option value="cstore">C-Store</option>
                            <option value="carwash">Car Wash</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_location">Location</label>
                        <select class="form-select" id="storeSelect" onchange="selectStore()">
                            <option value="">Choose store...</option>
                        </select>
                    </div>
                </div>

                <div id="actionButtons" class="action-grid hidden">
                    <div class="action-card" onclick="showNewIssueScreen()">
                        <div class="action-icon">üìù</div>
                        <div class="action-title">Report New Issue</div>
                        <div class="action-desc">Submit a repair ticket</div>
                    </div>
                    <div class="action-card" onclick="showExistingIssuesScreen()">
                        <div class="action-icon">üìã</div>
                        <div class="action-title">Existing Tickets</div>
                        <div class="action-desc">View and track open issues</div>
                    </div>
                </div>
            </div>


            <!-- Map Overview (for Admin/Area Coach after type selection) -->
            <div id="mapOverview" class="hidden">
                <div class="map-card">
                    <div class="map-header">
                        <h2 id="mapTitle">Store Overview</h2>
                        <div class="map-legend">
                            <span><span class="dot dot-green"></span> No issues</span>
                            <span><span class="dot dot-yellow"></span> Low/Routine</span>
                            <span><span class="dot dot-red"></span> Urgent/Emergency</span>
                        </div>
                    </div>
                    <div id="overviewMap"></div>
                    <div class="map-stats-bar" id="mapStatsBar"></div>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: New Issue Form ===== -->
        <div id="newIssueScreen" class="hidden">
            <div class="back-row">
                <button class="btn-back" onclick="goBack()" data-i18n="back_store">‚Üê Back to store</button>
            </div>

            <div class="issue-form-card">
                <div class="issue-form-header">
                    <h2 data-i18n="report_new">Report New Issue</h2>
                    <p id="newIssueStoreName">Store Name</p>
                </div>

                <div class="issue-form-body">
                    <!-- Category -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_category">Category</label>
                        <div class="category-grid" id="categoryGrid">
                            <button class="category-btn" data-cat="plumbing" onclick="selectCategory(this)">
                                <span class="cat-icon">üöø</span>
                                <span class="cat-label" data-i18n="cat_plumbing">Plumbing</span>
                            </button>
                            <button class="category-btn" data-cat="equipment" onclick="selectCategory(this)">
                                <span class="cat-icon">‚öôÔ∏è</span>
                                <span class="cat-label" data-i18n="cat_equipment">Equipment</span>
                            </button>
                            <button class="category-btn" data-cat="it" onclick="selectCategory(this)">
                                <span class="cat-icon">üíª</span>
                                <span class="cat-label" data-i18n="cat_it">IT</span>
                            </button>
                            <button class="category-btn" data-cat="structural" onclick="selectCategory(this)">
                                <span class="cat-icon">üß±</span>
                                <span class="cat-label" data-i18n="cat_structural">Structural</span>
                            </button>
                            <button class="category-btn" data-cat="safety" onclick="selectCategory(this)">
                                <span class="cat-icon">üõ°Ô∏è</span>
                                <span class="cat-label" data-i18n="cat_safety">Safety</span>
                            </button>
                            <button class="category-btn" data-cat="other" onclick="selectCategory(this)">
                                <span class="cat-icon">üìé</span>
                                <span class="cat-label" data-i18n="cat_other">Other</span>
                            </button>
                        </div>
                    </div>

                    <!-- Interior / Exterior -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_location">Location</label>
                        <div class="priority-options" style="max-width:280px">
                            <button class="priority-btn" data-loc="interior" onclick="selectLocation(this)">
                                <span class="priority-icon">üè†</span>
                                <span class="priority-label" data-i18n="loc_interior">Interior</span>
                            </button>
                            <button class="priority-btn" data-loc="exterior" onclick="selectLocation(this)">
                                <span class="priority-icon">üè™</span>
                                <span class="priority-label" data-i18n="loc_exterior">Exterior</span>
                            </button>
                        </div>
                    </div>

                    <!-- Contact Info -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_name">Your Name</label>
                        <input class="form-input" type="text" id="contactName" placeholder="Name of person reporting issue" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_phone">Your Contact Phone</label>
                        <input class="form-input" type="tel" id="contactPhone" placeholder="555-123-4567" inputmode="tel" maxlength="12" oninput="formatPhone(this)">
                    </div>

                    <!-- Priority -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_priority">Priority</label>
                        <div class="priority-options">
                            <button class="priority-btn p-routine" data-priority="routine" onclick="selectPriority(this)">
                                <span class="priority-icon">üü¢</span>
                                <span class="priority-label" data-i18n="p_routine">Routine</span>
                                <span class="priority-desc" data-i18n="p_routine_desc">Up to 1 week</span>
                            </button>
                            <button class="priority-btn p-urgent" data-priority="urgent" onclick="selectPriority(this)">
                                <span class="priority-icon">üü°</span>
                                <span class="priority-label" data-i18n="p_urgent">Urgent</span>
                                <span class="priority-desc" data-i18n="p_urgent_desc">Within 72 hours</span>
                            </button>
                            <button class="priority-btn p-emergency" data-priority="emergency" onclick="selectPriority(this)">
                                <span class="priority-icon">üî¥</span>
                                <span class="priority-label" data-i18n="p_emergency">Emergency</span>
                                <span class="priority-desc" data-i18n="p_emergency_desc">Within 24 hours</span>
                            </button>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_description">Description</label>
                        <textarea class="form-textarea" id="issueDescription" placeholder="Describe the issue in detail. What's broken? Where exactly? When did it start?"></textarea>
                    </div>

                    <!-- Photos -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="form_photos">Photos <span style="font-weight:400; color: var(--text-muted);" data-i18n="form_photos_hint">(required, at least 1, up to 3)</span></label>
                        <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click()">
                            <div class="upload-icon">üì∑</div>
                            <div class="upload-text" data-i18n="tap_photos">Tap to add photos</div>
                            <div class="upload-hint" data-i18n="photo_hint">JPG or PNG, max 5MB each</div>
                        </div>
                        <input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="handlePhotos(this)">
                        <div class="photo-preview-grid" id="photoPreviewGrid"></div>
                    </div>

                    <!-- Submit -->
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="goBack()">Cancel</button>
                        <button class="btn btn-primary" onclick="submitTicket()" id="submitBtn">Submit Ticket</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== SCREEN: Existing Issues ===== -->
        <div id="existingIssuesScreen" class="hidden">
            <div class="back-row">
                <button class="btn-back" onclick="goBack()">‚Üê Back to store</button>
            </div>

            <div class="tickets-header">
                <h2>Tickets <span id="ticketStoreName" style="font-weight:400; color: var(--text-muted); font-size: 15px;"></span></h2>
                <button class="btn btn-primary btn-sm" onclick="showNewIssueScreen()">+ New Ticket</button>
            </div>

            <div class="ticket-filters" id="ticketFilters">
                <button class="filter-chip active" data-filter="all" onclick="filterTickets('all', this)">All</button>
                <button class="filter-chip" data-filter="open" onclick="filterTickets('open', this)">Open</button>
                <button class="filter-chip" data-filter="assigned" onclick="filterTickets('assigned', this)">Assigned</button>
                <button class="filter-chip" data-filter="inprogress" onclick="filterTickets('inprogress', this)">In Progress</button>
                <button class="filter-chip" data-filter="waiting" onclick="filterTickets('waiting', this)">Waiting</button>
                <button class="filter-chip" data-filter="resolved" onclick="filterTickets('resolved', this)">Resolved</button>
                <button class="filter-chip" data-filter="closed" onclick="filterTickets('closed', this)">Closed</button>
            </div>

            <div class="tickets-list" id="ticketsList">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- ===== SCREEN: All Tickets (from stats bar click) ===== -->
        <div id="allTicketsScreen" class="hidden">
            <div class="back-row">
                <button class="btn-back" onclick="goHome()">‚Üê Back to overview</button>
            </div>
            <div class="tickets-header">
                <h2 id="allTicketsTitle">All Tickets</h2>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
                <select class="form-select" id="atFilterStatus" onchange="filterAllTickets()" style="width:auto;min-width:130px;font-size:13px;padding:6px 10px">
                    <option value="open">Open Tickets</option>
                    <option value="all">All Statuses</option>
                    <option value="assigned">Assigned</option>
                    <option value="inprogress">In Progress</option>
                    <option value="waiting">Waiting</option>
                    <option value="resolved">Resolved</option>
                    <option value="closed">Closed</option>
                </select>
                <select class="form-select" id="atFilterType" onchange="filterAllTickets()" style="width:auto;min-width:130px;font-size:13px;padding:6px 10px">
                    <option value="">All Store Types</option>
                    <option value="fastfood">Fast Food</option>
                    <option value="cstore">C-Store</option>
                    <option value="carwash">Car Wash</option>
                </select>
                <select class="form-select" id="atFilterStore" onchange="filterAllTickets()" style="width:auto;min-width:160px;font-size:13px;padding:6px 10px">
                    <option value="">All Stores</option>
                </select>
            </div>
            <div class="tickets-list" id="allTicketsList"></div>
        </div>

        <!-- ===== SCREEN: Admin Panel ===== -->
        <div id="adminScreen" class="hidden">
            <div class="back-row">
                <button class="btn btn-ghost" onclick="goBackFromAdmin()">‚Üê Back</button>
                <h2>Admin Panel</h2>
            </div>

            <!-- Pending Users -->
            <div class="admin-section">
                <div class="admin-section-header">
                    <h3>üïê Pending Approval <span id="pendingCount" style="color:var(--text-muted);font-weight:400;font-size:13px"></span></h3>
                </div>
                <div class="admin-section-body" id="pendingList">
                    <div class="empty-state">No pending users</div>
                </div>
            </div>

            <!-- Active Users -->
            <div class="admin-section">
                <div class="admin-section-header">
                    <h3>üë• Active Users <span id="activeCount" style="color:var(--text-muted);font-weight:400;font-size:13px"></span></h3>
                </div>
                <div class="admin-section-body" id="activeUsersList">
                    <div class="empty-state">Loading...</div>
                </div>
            </div>

            <!-- Add User -->
            <div class="admin-section">
                <div class="admin-section-header">
                    <h3>‚ûï Add New User</h3>
                </div>
                <div class="admin-section-body" id="addUserSection">
                    <div style="display:grid;gap:12px">
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Name</label>
                            <input class="form-input" type="text" id="newUserName" placeholder="Full name">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Email</label>
                            <input class="form-input" type="email" id="newUserEmail" placeholder="user@dossaniparadise.com">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="newUserRole">
                                <option value="">Choose role...</option>
                                <option value="Admin">Admin</option>
                                <option value="Area Coach">Area Coach</option>
                                <option value="Manager">Manager</option>
                                <option value="Technician">Technician</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Ticket Categories (for notification routing)</label>
                            <div id="newUserCats" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px"></div>
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Store Access <button class="btn btn-ghost" style="font-size:11px;padding:2px 8px;margin-left:8px" onclick="toggleAllNewUserStores()">Select All / None</button></label>
                            <div id="newUserStores" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:4px;margin-top:6px;max-height:300px;overflow-y:auto;padding:8px;border:1px solid var(--border);border-radius:8px;background:var(--bg)"></div>
                        </div>
                        <button class="btn btn-primary" onclick="addNewUser()">Add User to System</button>
                    </div>
                </div>
            </div>

            <!-- Database Cleanup -->
            <div class="admin-section">
                <div class="admin-section-header">
                    <h3>üßπ Database Cleanup</h3>
                </div>
                <div class="admin-section-body" id="cleanupSection">
                    <p style="font-size:13px;color:var(--text-mid);margin-bottom:12px">Remove old data nodes from the previous app version that are no longer needed.</p>
                    <div id="cleanupNodes" style="margin-bottom:12px"></div>
                    <button class="btn btn-secondary" onclick="scanOldNodes()" id="scanBtn">Scan for old data</button>
                </div>
            </div>

            <!-- Notification Routing -->
            <div class="admin-section">
                <div class="admin-section-header">
                    <h3>üîî Notification Routing</h3>
                </div>
                <div class="admin-section-body" id="notifySection">
                    <p style="font-size:13px;color:var(--text-mid);margin-bottom:14px">Set up to 3 users per category. These users will see matching tickets in their notification bell when they log in.</p>
                    <div id="notifyGrid"></div>
                    <button class="btn btn-primary" onclick="saveNotifyRouting()" style="margin-top:12px">Save Routing</button>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Ticket Detail Modal -->
<div class="modal-overlay" id="ticketModal" onclick="if(event.target===this)closeModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTicketId">Ticket #---</h3>
            <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Populated by JS -->
        </div>
    </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <img id="lightboxImg" src="" alt="Photo">
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- ============================================================
     FIREBASE SDK
     ============================================================ -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="stores-data.js"></script>
<script src="users-data.js"></script>

<script>
// ============================================================
// FIREBASE CONFIG
// ============================================================
const firebaseConfig = {
    apiKey: "AIzaSyDf0W5a8UPpuZbo873nWfed6VvNExL4BjM",
    authDomain: "dossani-paradise-rm-tracker.firebaseapp.com",
    databaseURL: "https://dossani-paradise-rm-tracker-default-rtdb.firebaseio.com",
    projectId: "dossani-paradise-rm-tracker",
    storageBucket: "dossani-paradise-rm-tracker.firebasestorage.app",
    messagingSenderId: "328034984226",
    appId: "1:328034984226:web:2b2ddb58d935bec201857b"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// ============================================================
// STORES & USERS DATA - loaded from external files
// stores-data.js must define: const stores = [...]
// users-data.js is reference only (actual auth is Firebase DB)
// ============================================================

// LOGO URLS - relative to index.html
const BRAND_LOGOS = {
    bk: 'logos/bk-logo.png',
    sub: 'logos/subway-logo.png',
    pqs: 'logos/pqs-logo.png',
    '711': 'logos/711-logo.png',
    cw: 'logos/cw-logo.png',
    nash: 'logos/pqs-logo.png',
    dpm: 'logos/dpm-icon.png'
};

// ============================================================
// APP STATE
// ============================================================
let currentUser = null;
let selectedStore = null;
let selectedCategory = null;
let selectedLocation = null;
let selectedPriority = null;
let uploadedPhotos = []; // { file, previewUrl }
let currentTickets = [];
let currentFilter = 'all';
let activeTicketListener = null;

// ============================================================
// AUTH
// ============================================================
auth.onAuthStateChanged(async (user) => {
    if (user) {
        console.log('Signed in:', user.email);
        await loadUserData(user);
    } else if (auth.isSignInWithEmailLink(window.location.href)) {
        handleEmailLinkSignIn();
    } else {
        showLoginScreen();
    }
});

async function sendSignInLink() {
    const email = document.getElementById('loginEmail').value.trim().toLowerCase();
    if (!email) { showError('Enter your email address.'); return; }

    if (!email.endsWith('@dossaniparadise.com') && email !== 'scroadmart@att.net') {
        showError('Only @dossaniparadise.com emails are allowed.');
        return;
    }

    const btn = document.getElementById('sendLinkBtn');
    btn.innerHTML = '<span class="spinner"></span>';
    btn.disabled = true;

    try {
        await auth.sendSignInLinkToEmail(email, { url: window.location.href, handleCodeInApp: true });
        window.localStorage.setItem('emailForSignIn', email);
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('emailSentMessage').classList.remove('hidden');
        document.getElementById('sentToEmail').textContent = email;
    } catch (err) {
        console.error('Send link error:', err);
        showError(err.code === 'auth/invalid-email' ? 'Invalid email.' : 'Failed to send. Try again.');
    } finally {
        btn.innerHTML = 'Send Sign-In Link';
        btn.disabled = false;
    }
}

// Allow pressing Enter on email input
document.getElementById('loginEmail').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendSignInLink();
});

async function handleEmailLinkSignIn() {
    let email = window.localStorage.getItem('emailForSignIn');
    if (!email) email = window.prompt('Confirm your email:');
    if (!email) { showLoginScreen(); return; }

    try {
        await auth.signInWithEmailLink(email, window.location.href);
        window.localStorage.removeItem('emailForSignIn');
        window.history.replaceState({}, document.title, window.location.pathname);
    } catch (err) {
        console.error('Link sign-in error:', err);
        const msgs = {
            'auth/invalid-action-code': 'This link has expired or was already used. Request a new one.',
            'auth/invalid-email': 'Invalid email. Try again.',
            'auth/user-disabled': 'Account disabled. Contact IT.'
        };
        showError(msgs[err.code] || 'Sign-in failed: ' + err.message);
        window.history.replaceState({}, document.title, window.location.pathname);
        showLoginScreen();
    }
}

function resendEmail() {
    document.getElementById('emailSentMessage').classList.add('hidden');
    document.getElementById('loginForm').classList.remove('hidden');
}

async function loadUserData(user) {
    try {
        const snap = await db.ref(`users/${user.uid}`).once('value');
        let data = snap.val();

        if (!data) {
            // Check if user was pre-approved by admin
            const emailKey = user.email.toLowerCase().replace(/\./g, ',');
            const preSnap = await db.ref(`preApproved/${emailKey}`).once('value');
            const preData = preSnap.val();

            if (preData) {
                // Auto-activate pre-approved user
                data = {
                    name: preData.name,
                    email: user.email,
                    role: preData.role,
                    stores: preData.stores,
                    status: 'active',
                    activatedAt: firebase.database.ServerValue.TIMESTAMP
                };
                await db.ref(`users/${user.uid}`).set(data);
                // Clean up pre-approval entry
                await db.ref(`preApproved/${emailKey}`).remove();
            } else {
                // Auto-register as pending
                try {
                    await db.ref(`pending/${user.uid}`).set({
                        email: user.email,
                        requestedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    showError('Your account is pending approval. An admin will set you up shortly.');
                } catch (e) {
                    console.warn('Could not write pending entry:', e);
                    showError('Account not set up yet. Contact IT at itsupport@dossaniparadise.com to get access.');
                }
                auth.signOut();
                return;
            }
        }

        currentUser = {
            uid: user.uid,
            email: user.email,
            name: data.name || user.email.split('@')[0],
            role: normalizeRole(data.role),
            stores: data.stores || []
        };

        showAppScreen();
    } catch (err) {
        console.error('Load user error:', err);
        showError('Failed to load account. Try again.');
    }
}

function logout() {
    if (activeTicketListener) { activeTicketListener(); activeTicketListener = null; }
    if (notifyListenerRef && notifyListenerCallback) {
        notifyListenerRef.off('value', notifyListenerCallback);
        notifyListenerRef = null;
        notifyListenerCallback = null;
    }
    notifyTickets = [];
    auth.signOut();
}

// ============================================================
// SCREENS
// ============================================================
function showLoginScreen() {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appContainer').style.display = 'none';
}

function showAppScreen() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContainer').style.display = 'flex';

    // Populate header
    const initials = currentUser.name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
    document.getElementById('userAvatar').textContent = initials || '?';
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userRole').textContent = currentUser.role;

    // Show admin button for admins (case-insensitive check)
    if (currentUser.role && currentUser.role.toLowerCase() === 'admin') {
        document.getElementById('adminBtn').classList.remove('hidden');
        watchPendingUsers();
    }

    // Show "All Locations" pill for admins
    if (currentUser.role === 'Admin' || currentUser.stores === 'all') {
        document.getElementById('brandPill-all').classList.remove('hidden');
        document.querySelectorAll('.admin-only-opt').forEach(el => el.classList.remove('hidden'));
    }

    // Show "View As" only for itsupport
    if (currentUser.email === 'itsupport@dossaniparadise.com') {
        document.getElementById('viewAsBtn').classList.remove('hidden');
    }

    // Load notification routing config
    db.ref('config/notifyRouting').once('value', snap => {
        notifyRouting = snap.val() || {};
        initNotificationCenter();
    });

    // Auto-select store for single-store managers
    if (currentUser.role === 'Manager' && currentUser.stores && !Array.isArray(currentUser.stores)) {
        const store = stores.find(s => s.code === currentUser.stores);
        if (store) {
            selectedStore = store;
            document.getElementById('storeType').value = store.type;
            filterStores();
            document.getElementById('storeSelect').value = store.id;
            selectStore();
        }
    }
}

function showError(msg) {
    const el = document.getElementById('loginError');
    el.textContent = msg;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 8000);
}

function showScreen(screenId) {
    ['storeSelection', 'newIssueScreen', 'existingIssuesScreen', 'allTicketsScreen', 'adminScreen'].forEach(id => {
        document.getElementById(id).classList.toggle('hidden', id !== screenId);
    });
}

function goBack() {
    showScreen('storeSelection');
    resetNewIssueForm();
    if (activeTicketListener) { activeTicketListener(); activeTicketListener = null; }
}

// ============================================================
// STORE SELECTION
// ============================================================
function filterStores() {
    const type = document.getElementById('storeType').value;
    const sel = document.getElementById('storeSelect');
    sel.innerHTML = '<option value="">Choose store...</option>';
    document.getElementById('actionButtons').classList.add('hidden');
    selectedStore = null;

    if (!type) return;

    let filtered = stores.filter(s => s.type === type);

    // Permission filtering
    if (currentUser.role !== 'Admin' && currentUser.stores !== 'all') {
        const userStores = Array.isArray(currentUser.stores) ? currentUser.stores : [currentUser.stores];
        filtered = filtered.filter(s => userStores.includes(s.code));
    }

    filtered.sort((a, b) => a.name.localeCompare(b.name));
    filtered.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        sel.appendChild(opt);
    });
}

function selectStore() {
    const id = document.getElementById('storeSelect').value;
    if (!id) { document.getElementById('actionButtons').classList.add('hidden'); selectedStore = null; return; }
    selectedStore = stores.find(s => s.id === id);
    document.getElementById('actionButtons').classList.remove('hidden');
}



// ============================================================
// MAP OVERVIEW (for Admin / Area Coach)
// ============================================================
let overviewMap = null;
let mapMarkers = [];
let allTicketCounts = {}; // { storeCode: { open: N, total: N } }

function isMultiStoreUser() {
    return currentUser && (currentUser.role === 'Admin' || currentUser.role === 'Area Coach');
}

// Brand pill click ‚Üí set dropdown + trigger map
function selectBrand(type) {
    document.getElementById('storeType').value = type;
    document.querySelectorAll('.brand-pill').forEach(b => b.classList.remove('active'));
    const pill = document.getElementById('brandPill-' + type);
    if (pill) pill.classList.add('active');
    filterStores();
}

// Override filterStores to sync pill active state
const _origFilterStores = filterStores;
filterStores = function() {
    _origFilterStores();
    const type = document.getElementById('storeType').value;
    
    // Sync pill active state
    document.querySelectorAll('.brand-pill').forEach(b => b.classList.remove('active'));
    if (type) {
        const pill = document.getElementById('brandPill-' + type);
        if (pill) pill.classList.add('active');
    }
    
    const mapEl = document.getElementById('mapOverview');
    
    if (type && isMultiStoreUser()) {
        mapEl.classList.remove('hidden');
        loadMapOverview(type);
    } else {
        mapEl.classList.add('hidden');
    }
    
    // For 'all' type, also show all stores in dropdown
    if (type === 'all') {
        const storeSelect = document.getElementById('storeSelect');
        let allStores = [...stores];
        if (currentUser.role !== 'Admin' && currentUser.stores !== 'all') {
            const us = Array.isArray(currentUser.stores) ? currentUser.stores : [currentUser.stores];
            allStores = allStores.filter(s => us.includes(s.code));
        }
        storeSelect.innerHTML = '<option value="">Choose store...</option>' +
            allStores.map(s => '<option value="' + s.id + '">' + s.name + '</option>').join('');
    }
};

function loadMapOverview(type) {
    let filtered = type === 'all' ? [...stores] : stores.filter(s => s.type === type);
    
    // Permission filter
    if (currentUser.role !== 'Admin' && currentUser.stores !== 'all') {
        const us = Array.isArray(currentUser.stores) ? currentUser.stores : [currentUser.stores];
        filtered = filtered.filter(s => us.includes(s.code));
    }
    
    const typeLabels = { all: 'All Locations', fastfood: 'Fast Food Stores', cstore: 'C-Stores', carwash: 'Car Washes' };
    document.getElementById('mapTitle').textContent = typeLabels[type] || 'Stores';
    
    // Init or clear map
    if (!overviewMap) {
        overviewMap = L.map('overviewMap', { zoomControl: true, attributionControl: false }).setView([33.0, -96.5], 7);
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        currentTileLayer = L.tileLayer(isDark ? DARK_TILES : LIGHT_TILES, {
            maxZoom: 18
        }).addTo(overviewMap);
        setTimeout(() => overviewMap.invalidateSize(), 100);
    } else {
        overviewMap.invalidateSize();
    }
    
    // Clear old markers
    mapMarkers.forEach(m => overviewMap.removeLayer(m));
    mapMarkers = [];
    
    // Fetch open ticket counts for these stores
    const codes = filtered.map(s => s.code);
    fetchTicketCounts(codes, () => {
        // Add markers
        const bounds = [];
        filtered.forEach(s => {
            if (!s.lat || !s.lng) return;
            const counts = allTicketCounts[s.code] || { open: 0, total: 0, score: 0, hasEmergency: false };
            // Color: green = no issues, yellow = low severity, red = emergency or high score
            const color = counts.open === 0 ? '#059669' : (counts.hasEmergency || counts.score >= 3) ? '#dc2626' : '#d97706';
            const size = counts.open === 0 ? 10 : (counts.hasEmergency || counts.score >= 3) ? 16 : 13;
            
            const icon = L.divIcon({
                className: '',
                html: '<div style="width:'+size+'px;height:'+size+'px;border-radius:50%;background:'+color+';border:2px solid rgba(255,255,255,0.3);box-shadow:0 0 8px '+color+'55;'+(counts.open > 0 ? 'display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#000;' : '')+'">'+( counts.open > 0 ? counts.open : '')+'</div>',
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
            
            const marker = L.marker([s.lat, s.lng], { icon: icon }).addTo(overviewMap);
            
            const shortName = s.name.replace(/^Burger King /, 'BK ').replace(/^Paradise QS /, 'PQS ');
            const mapsUrl = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(s.address);
            
            marker.bindPopup(`<div class="map-popup">
                <div class="mp-name">${shortName}</div>
                <div class="mp-addr" onclick="window.open('${mapsUrl}','_blank')">${s.address}</div>
                <div class="mp-stats">
                    <div class="mp-stat"><strong style="color:${counts.open > 0 ? '#f87171' : '#34d399'}">${counts.open}</strong>open</div>
                    <div class="mp-stat"><strong>${counts.total}</strong>total</div>
                </div>
                <div class="mp-btns">
                    <button class="mp-btn" onclick="mapSelectStore('${s.id}','tickets')">View Tickets</button>
                    <button class="mp-btn" onclick="mapSelectStore('${s.id}','new')">Report Issue</button>
                </div>
            </div>`, { maxWidth: 260, closeButton: false });
            
            mapMarkers.push(marker);
            bounds.push([s.lat, s.lng]);
        });
        
        if (bounds.length) {
            overviewMap.fitBounds(bounds, { padding: [30, 30], maxZoom: 12 });
        }
        
        // Stats bar
        let totalOpen = 0, totalAll = 0, storesWithIssues = 0;
        codes.forEach(c => {
            const ct = allTicketCounts[c] || { open: 0, total: 0 };
            totalOpen += ct.open;
            totalAll += ct.total;
            if (ct.open > 0) storesWithIssues++;
        });
        document.getElementById('mapStatsBar').innerHTML = 
            '<div class="mstat"><strong>' + filtered.length + '</strong>stores</div>' +
            '<div class="mstat" style="cursor:pointer" onclick="showAllTickets(\'open\')"><strong style="color:' + (totalOpen > 0 ? '#dc2626' : '#059669') + '">' + totalOpen + '</strong>open tickets</div>' +
            '<div class="mstat" style="cursor:pointer" onclick="showAllTickets(\'open\')"><strong>' + storesWithIssues + '</strong>need attention</div>' +
            '<div class="mstat" style="cursor:pointer" onclick="showAllTickets(\'all\')"><strong>' + totalAll + '</strong>total tickets</div>';
    });
}

function fetchTicketCounts(codes, callback) {
    // Listen once for all tickets and count per store
    // Priority weighting: emergency = auto red (score 3), urgent = 2, routine = 1
    db.ref('tickets').once('value', snap => {
        allTicketCounts = {};
        codes.forEach(c => allTicketCounts[c] = { open: 0, total: 0, score: 0, hasEmergency: false });
        snap.forEach(child => {
            const t = child.val();
            if (codes.includes(t.storeCode)) {
                if (!allTicketCounts[t.storeCode]) allTicketCounts[t.storeCode] = { open: 0, total: 0, score: 0, hasEmergency: false };
                allTicketCounts[t.storeCode].total++;
                if (t.status && t.status !== 'closed' && t.status !== 'resolved') {
                    allTicketCounts[t.storeCode].open++;
                    if (t.priority === 'emergency') {
                        allTicketCounts[t.storeCode].score += 3;
                        allTicketCounts[t.storeCode].hasEmergency = true;
                    } else if (t.priority === 'urgent') {
                        allTicketCounts[t.storeCode].score += 2;
                    } else {
                        allTicketCounts[t.storeCode].score += 1;
                    }
                }
            }
        });
        callback();
    });
}

function mapSelectStore(storeId, action) {
    // Set the dropdown and select the store
    const store = stores.find(s => s.id === storeId);
    if (!store) return;
    selectedStore = store;
    document.getElementById('storeSelect').value = storeId;
    document.getElementById('actionButtons').classList.remove('hidden');
    // Close any open popup
    if (overviewMap) overviewMap.closePopup();
    // Navigate
    if (action === 'tickets') {
        showExistingIssuesScreen();
    } else {
        showNewIssueScreen();
    }
}

// Also hide map when going back
const _origGoBack = goBack;
goBack = function() {
    _origGoBack();
    // Don't hide map - it stays visible on storeSelection if type is set
};

// ============================================================
// ADMIN PANEL
// ============================================================
let pendingListener = null;
let pendingUsers = {};

function watchPendingUsers() {
    if (pendingListener) return;
    pendingListener = db.ref('pending').on('value', snap => {
        pendingUsers = snap.val() || {};
        const count = Object.keys(pendingUsers).length;
        const badge = document.getElementById('pendingBadge');
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
        // If admin panel is visible, refresh it
        if (!document.getElementById('adminScreen').classList.contains('hidden')) {
            renderPendingUsers();
        }
    });
}

function showAdminPanel() {
    showScreen('adminScreen');
    renderPendingUsers();
    loadActiveUsers();
    loadNotifyRouting();
    renderAddUserForm();
}

function goBackFromAdmin() {
    showScreen('storeSelection');
}

function renderPendingUsers() {
    const container = document.getElementById('pendingList');
    const entries = Object.entries(pendingUsers);
    const count = entries.length;
    document.getElementById('pendingCount').textContent = count > 0 ? `(${count})` : '';

    if (count === 0) {
        container.innerHTML = '<div class="empty-state">No pending users</div>';
        return;
    }

    container.innerHTML = entries.map(([uid, p]) => {
        const email = (p.email || '').toLowerCase();
        // Auto-lookup from USER_DIRECTORY
        const known = (typeof USER_DIRECTORY !== 'undefined') ? USER_DIRECTORY[email] : null;
        const guessedName = known ? known.name : email.split('@')[0].replace(/\./g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        const guessedRole = known ? known.role : 'Manager';
        const guessedStores = known ? (known.stores === 'all' ? [] : Array.isArray(known.stores) ? known.stores : [known.stores]) : [];
        const isKnown = !!known;
        const timeStr = p.requestedAt ? new Date(p.requestedAt).toLocaleString() : 'Unknown';

        return `<div class="pending-card" id="pending-${uid}">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <div class="pending-email">${esc(p.email || 'Unknown')}</div>
                ${isKnown ? '<span style="font-size:11px;color:#059669;font-weight:600">‚úì Found in directory</span>' : '<span style="font-size:11px;color:var(--accent);font-weight:600">‚ö† Not in directory</span>'}
            </div>
            <div class="pending-time">Requested: ${timeStr}</div>
            <div class="pending-form">
                <input type="text" placeholder="Full name" id="pname-${uid}" value="${esc(guessedName)}">
                <select id="prole-${uid}">
                    <option value="Manager" ${guessedRole === 'Manager' ? 'selected' : ''}>Manager</option>
                    <option value="Area Coach" ${guessedRole === 'Area Coach' ? 'selected' : ''}>Area Coach</option>
                    <option value="Admin" ${guessedRole === 'Admin' ? 'selected' : ''}>Admin</option>
                </select>
                <select id="pstores-${uid}" class="full" multiple size="3" style="min-height:70px">
                    ${stores.map(s => `<option value="${s.code}" ${guessedStores.includes(s.code) ? 'selected' : ''}>${s.name}</option>`).join('')}
                </select>
                <div class="full" style="font-size:11px;color:var(--text-muted)">
                    ${guessedRole === 'Admin' ? 'Admin gets all stores automatically.' : 'Hold Ctrl/Cmd to select multiple stores.'}
                </div>
            </div>
            <div class="pending-actions">
                <button class="btn btn-primary" onclick="approveUser('${uid}')">${isKnown ? '‚úì Approve' : 'Approve'}</button>
                <button class="btn btn-secondary" onclick="denyUser('${uid}')">Deny</button>
            </div>
        </div>`;
    }).join('');
}

async function approveUser(uid) {
    const name = document.getElementById(`pname-${uid}`).value.trim();
    const role = document.getElementById(`prole-${uid}`).value;
    const storeSelect = document.getElementById(`pstores-${uid}`);
    const selectedStores = Array.from(storeSelect.selectedOptions).map(o => o.value);

    if (!name) { showToast('Enter a name', 'error'); return; }

    let storeVal;
    if (role === 'Admin') {
        storeVal = 'all';
    } else if (selectedStores.length === 0) {
        showToast('Select at least one store', 'error');
        return;
    } else if (selectedStores.length === 1 && role === 'Manager') {
        storeVal = selectedStores[0];
    } else {
        storeVal = selectedStores;
    }

    try {
        await db.ref(`users/${uid}`).set({
            name: name,
            role: role,
            stores: storeVal,
            email: pendingUsers[uid]?.email || '',
            approvedAt: firebase.database.ServerValue.TIMESTAMP,
            approvedBy: currentUser.email
        });
        await db.ref(`pending/${uid}`).remove();
        showToast(`${name} approved as ${role}`, 'success');
    } catch (err) {
        console.error('Approve error:', err);
        showToast('Failed to approve: ' + err.message, 'error');
    }
}

async function denyUser(uid) {
    if (!confirm('Deny this user? They will need to request access again.')) return;
    try {
        await db.ref(`pending/${uid}`).remove();
        showToast('User denied', 'success');
    } catch (err) {
        showToast('Failed: ' + err.message, 'error');
    }
}

async function loadActiveUsers() {
    const container = document.getElementById('activeUsersList');
    try {
        const snap = await db.ref('users').once('value');
        const users = snap.val() || {};
        const entries = Object.entries(users);
        document.getElementById('activeCount').textContent = `(${entries.length})`;

        if (entries.length === 0) {
            container.innerHTML = '<div class="empty-state">No active users</div>';
            return;
        }

        container.innerHTML = entries.map(([uid, u]) => {
            const initials = (u.name || '?').split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
            const roleClass = u.role === 'Admin' ? 'admin' : u.role === 'Area Coach' ? 'areacoach' : 'manager';
            const storeStr = u.stores === 'all' ? 'All stores' :
                Array.isArray(u.stores) ? u.stores.length + ' stores' :
                u.stores || 'None';

            return `<div class="user-row">
                <div class="user-row-avatar">${initials}</div>
                <div class="user-row-info">
                    <div class="user-row-name">${esc(u.name || 'Unknown')}</div>
                    <div class="user-row-email">${esc(u.email || uid)} ¬∑ ${storeStr}</div>
                </div>
                <span class="user-row-role ${roleClass}">${u.role || 'Manager'}</span>
                <div class="user-row-actions">
                    <button onclick="editUser('${uid}')">Edit</button>
                    <button class="del" onclick="removeUser('${uid}','${esc(u.name || '')}')">Remove</button>
                </div>
            </div>`;
        }).join('');
    } catch (err) {
        container.innerHTML = '<div class="empty-state">Error loading users</div>';
    }
}

function editUser(uid) {
    db.ref(`users/${uid}`).once('value', snap => {
        const u = snap.val();
        if (!u) return;

        const storesOptions = stores.map(s => {
            const selected = u.stores === 'all' ? false :
                Array.isArray(u.stores) ? u.stores.includes(s.code) :
                u.stores === s.code;
            return `<option value="${s.code}" ${selected ? 'selected' : ''}>${s.name}</option>`;
        }).join('');

        const overlay = document.createElement('div');
        overlay.className = 'admin-modal';
        overlay.id = 'editUserModal';
        overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
        overlay.innerHTML = `<div class="modal-card">
            <h3>Edit User</h3>
            <div class="form-group">
                <label class="form-label">Name</label>
                <input class="form-input" id="editName" value="${esc(u.name || '')}">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input class="form-input" value="${esc(u.email || uid)}" disabled style="opacity:.5">
            </div>
            <div class="form-group">
                <label class="form-label">Role</label>
                <select class="form-select" id="editRole">
                    <option value="Manager" ${u.role === 'Manager' ? 'selected' : ''}>Manager</option>
                    <option value="Area Coach" ${u.role === 'Area Coach' ? 'selected' : ''}>Area Coach</option>
                    <option value="Admin" ${u.role === 'Admin' ? 'selected' : ''}>Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Stores (Ctrl/Cmd+click for multiple; leave empty for Admin=all)</label>
                <select class="form-select" id="editStores" multiple size="5" style="min-height:100px">${storesOptions}</select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveEditUser('${uid}')">Save</button>
                <button class="btn btn-secondary" onclick="document.getElementById('editUserModal').remove()">Cancel</button>
            </div>
        </div>`;
        document.body.appendChild(overlay);
    });
}

async function saveEditUser(uid) {
    const name = document.getElementById('editName').value.trim();
    const role = document.getElementById('editRole').value;
    const selected = Array.from(document.getElementById('editStores').selectedOptions).map(o => o.value);

    if (!name) { showToast('Name required', 'error'); return; }

    let storeVal;
    if (role === 'Admin') {
        storeVal = 'all';
    } else if (selected.length === 0) {
        showToast('Select at least one store', 'error');
        return;
    } else if (selected.length === 1 && role === 'Manager') {
        storeVal = selected[0];
    } else {
        storeVal = selected;
    }

    try {
        await db.ref(`users/${uid}`).update({ name, role, stores: storeVal });
        document.getElementById('editUserModal').remove();
        showToast('User updated', 'success');
        loadActiveUsers();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function removeUser(uid, name) {
    if (!confirm(`Remove ${name || 'this user'}? They won't be able to sign in until re-approved.`)) return;
    try {
        await db.ref(`users/${uid}`).remove();
        showToast('User removed', 'success');
        loadActiveUsers();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

// Database cleanup
// ============================================================
// ADD NEW USER
// ============================================================
function renderAddUserForm() {
    const catsEl = document.getElementById('newUserCats');
    const allCats = ['plumbing', 'equipment', 'it', 'structural', 'safety', 'other'];
    catsEl.innerHTML = allCats.map(cat => `
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;padding:4px 8px;border:1px solid var(--border);border-radius:6px;background:var(--bg)">
            <input type="checkbox" class="new-user-cat" value="${cat}"> ${capitalize(cat)}
        </label>
    `).join('');

    const storesEl = document.getElementById('newUserStores');
    storesEl.innerHTML = stores.map(s => `
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;white-space:nowrap">
            <input type="checkbox" class="new-user-store" value="${s.code}"> ${s.name.length > 25 ? s.name.substring(0,25) + '...' : s.name}
        </label>
    `).join('');
}

let allNewUserStoresSelected = false;
function toggleAllNewUserStores() {
    allNewUserStoresSelected = !allNewUserStoresSelected;
    document.querySelectorAll('.new-user-store').forEach(cb => cb.checked = allNewUserStoresSelected);
}

async function addNewUser() {
    const name = document.getElementById('newUserName').value.trim();
    const email = document.getElementById('newUserEmail').value.trim().toLowerCase();
    const role = document.getElementById('newUserRole').value;

    if (!name) { toast('Enter a name', 'error'); return; }
    if (!email || !email.includes('@')) { toast('Enter a valid email', 'error'); return; }
    if (!role) { toast('Select a role', 'error'); return; }

    const selectedStores = [...document.querySelectorAll('.new-user-store:checked')].map(cb => cb.value);
    const selectedCats = [...document.querySelectorAll('.new-user-cat:checked')].map(cb => cb.value);

    if (selectedStores.length === 0 && role !== 'Admin') {
        toast('Select at least one store', 'error');
        return;
    }

    // Determine stores value
    let storesVal;
    if (role === 'Admin') {
        storesVal = 'all';
    } else if (selectedStores.length === 1) {
        storesVal = selectedStores[0];
    } else {
        storesVal = selectedStores;
    }

    // Save user to Firebase (pre-approved, ready to sign in)
    const userData = {
        name: name,
        email: email,
        role: role,
        stores: storesVal,
        status: 'active',
        addedAt: firebase.database.ServerValue.TIMESTAMP,
        addedBy: currentUser.email
    };

    try {
        // Store under a sanitized email key
        const emailKey = email.replace(/\./g, ',');
        await db.ref(`preApproved/${emailKey}`).set(userData);

        // Also update notification routing for selected categories
        if (selectedCats.length > 0) {
            const routingSnap = await db.ref('config/notifyRouting').once('value');
            const routing = routingSnap.val() || {};
            for (const cat of selectedCats) {
                if (!routing[cat]) routing[cat] = [];
                if (!routing[cat].includes(email)) {
                    routing[cat].push(email);
                }
            }
            await db.ref('config/notifyRouting').set(routing);
            notifyRouting = routing;
        }

        toast(`User ${name} added successfully`, 'success');

        // Clear form
        document.getElementById('newUserName').value = '';
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserRole').value = '';
        document.querySelectorAll('.new-user-store').forEach(cb => cb.checked = false);
        document.querySelectorAll('.new-user-cat').forEach(cb => cb.checked = false);
        allNewUserStoresSelected = false;
    } catch (err) {
        toast('Error: ' + err.message, 'error');
    }
}

async function scanOldNodes() {
    const btn = document.getElementById('scanBtn');
    btn.textContent = 'Scanning...';
    btn.disabled = true;
    
    const oldNodes = ['issues', 'stores', 'cameras'];
    const container = document.getElementById('cleanupNodes');
    const found = [];
    
    for (const node of oldNodes) {
        try {
            const snap = await db.ref(node).once('value');
            if (snap.exists()) {
                const count = snap.numChildren();
                found.push({ node, count });
            }
        } catch (e) { /* skip nodes we can't read */ }
    }
    
    // Also check for stale user entries (UIDs in /users that have no matching pending and weird data)
    
    if (found.length === 0) {
        container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:8px 0">‚úì Database is clean. No old data found.</div>';
    } else {
        container.innerHTML = found.map(f => `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--border-light);border-radius:8px;margin-bottom:6px">
                <div>
                    <strong style="font-size:13px">/${f.node}</strong>
                    <span style="font-size:12px;color:var(--text-muted);margin-left:8px">${f.count} entries</span>
                </div>
                <button class="btn btn-secondary" style="font-size:11px;padding:4px 10px" onclick="deleteNode('${f.node}')">Delete</button>
            </div>
        `).join('');
    }
    
    btn.textContent = 'Scan again';
    btn.disabled = false;
}

async function deleteNode(node) {
    if (!confirm(`Delete /${node} and all its data? This cannot be undone.`)) return;
    try {
        await db.ref(node).remove();
        showToast(`/${node} deleted`, 'success');
        scanOldNodes();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

// ============================================================
// NOTIFICATION ROUTING
// ============================================================
const CATEGORIES = ['plumbing','equipment','it','structural','safety','other'];
const CAT_LABELS = {plumbing:'Plumbing',equipment:'Equipment',it:'IT',structural:'Structural',safety:'Safety',other:'Other'};
let notifyRouting = {};

function loadNotifyRouting() {
    db.ref('config/notifyRouting').once('value', snap => {
        notifyRouting = snap.val() || {};
        renderNotifyGrid();
    });
}

function renderNotifyGrid() {
    const container = document.getElementById('notifyGrid');
    container.innerHTML = CATEGORIES.map(cat => {
        const emails = notifyRouting[cat] || ['','',''];
        return `<div style="margin-bottom:10px;padding:10px 12px;background:var(--border-light);border-radius:8px">
            <div style="font-size:12px;font-weight:700;margin-bottom:6px;color:var(--text-mid)">${CAT_LABELS[cat]}</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
                <input class="form-input" style="flex:1;min-width:160px;font-size:12px;padding:5px 8px" placeholder="Email 1" id="nr-${cat}-0" value="${esc(emails[0]||'')}">
                <input class="form-input" style="flex:1;min-width:160px;font-size:12px;padding:5px 8px" placeholder="Email 2" id="nr-${cat}-1" value="${esc(emails[1]||'')}">
                <input class="form-input" style="flex:1;min-width:160px;font-size:12px;padding:5px 8px" placeholder="Email 3" id="nr-${cat}-2" value="${esc(emails[2]||'')}">
            </div>
        </div>`;
    }).join('');
}

async function saveNotifyRouting() {
    const routing = {};
    CATEGORIES.forEach(cat => {
        const emails = [0,1,2].map(i => document.getElementById(`nr-${cat}-${i}`).value.trim().toLowerCase()).filter(Boolean);
        if (emails.length) routing[cat] = emails;
    });
    try {
        await db.ref('config/notifyRouting').set(routing);
        notifyRouting = routing;
        showToast('Notification routing saved', 'success');
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

// ============================================================
// NOTIFICATION CENTER
// ============================================================
let notifyTickets = [];
let notifyListenerRef = null;
let notifyListenerCallback = null;

function initNotificationCenter() {
    // Show bell for every logged-in user
    document.getElementById('notifyBtn').classList.remove('hidden');

    // Properly detach previous listener if any
    if (notifyListenerRef && notifyListenerCallback) {
        notifyListenerRef.off('value', notifyListenerCallback);
        notifyListenerRef = null;
        notifyListenerCallback = null;
    }

    // Determine which stores this user can see
    const isAdmin = currentUser.role === 'Admin' || currentUser.stores === 'all';
    let myStores = null;
    if (!isAdmin) {
        myStores = Array.isArray(currentUser.stores) ? currentUser.stores : 
                   (currentUser.stores ? [currentUser.stores] : []);
    }

    // Check notification routing for category-based visibility
    const myEmail = currentUser.email ? currentUser.email.toLowerCase() : '';
    const myRoutedCategories = [];
    if (notifyRouting && typeof notifyRouting === 'object') {
        for (const [cat, emails] of Object.entries(notifyRouting)) {
            if (Array.isArray(emails) && emails.some(e => e.toLowerCase() === myEmail)) {
                myRoutedCategories.push(cat);
            }
        }
    }

    console.log('[Notifications] Init for', currentUser.name, 
        '| isAdmin:', isAdmin, 
        '| myStores:', myStores, 
        '| routedCats:', myRoutedCategories);

    // Create the callback
    notifyListenerCallback = function(snap) {
        notifyTickets = [];
        snap.forEach(child => {
            const t = child.val();
            if (!t) return;
            t._key = child.key;

            // Skip closed/resolved tickets
            if (!t.status || t.status === 'closed' || t.status === 'resolved') return;

            // Store access check: admin sees all, others check store list
            let canSee = false;
            if (isAdmin) {
                canSee = true;
            } else if (myStores && myStores.length > 0 && t.storeCode) {
                canSee = myStores.includes(t.storeCode);
            }

            // Category routing: if user is routed for this category, also show it
            if (!canSee && myRoutedCategories.length > 0 && t.category) {
                canSee = myRoutedCategories.includes(t.category);
            }

            if (canSee) {
                notifyTickets.push(t);
            }
        });

        // Sort: emergency first, then urgent, then routine, then by newest
        const priOrder = { emergency: 0, urgent: 1, routine: 2 };
        notifyTickets.sort((a, b) => 
            (priOrder[a.priority] || 2) - (priOrder[b.priority] || 2) || 
            (b.createdAt || 0) - (a.createdAt || 0)
        );

        console.log('[Notifications] Found', notifyTickets.length, 'tickets for', currentUser.name);
        updateNotifyBadge();

        // If panel is open, refresh it live
        const panel = document.getElementById('notifyPanel');
        if (panel && panel.classList.contains('open')) {
            renderNotifyPanel();
        }
    };

    // Attach listener
    notifyListenerRef = db.ref('tickets');
    notifyListenerRef.on('value', notifyListenerCallback);
}

function updateNotifyBadge() {
    const badge = document.getElementById('notifyBadge');
    const count = notifyTickets.length;
    if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

function toggleNotifyPanel() {
    const panel = document.getElementById('notifyPanel');
    const isOpen = panel.classList.contains('open');
    if (isOpen) {
        panel.classList.remove('open');
        return;
    }
    panel.classList.add('open');
    renderNotifyPanel();
}

function renderNotifyPanel() {
    const body = document.getElementById('notifyPanelBody');
    if (notifyTickets.length === 0) {
        const lang = currentLang === 'es' ? 'No hay tickets abiertos' : 'No open tickets';
        body.innerHTML = '<div class="notify-empty">' + lang + '</div>';
        return;
    }
    const lang = currentLang === 'es';
    body.innerHTML = notifyTickets.map(t => {
        const priClass = t.priority === 'emergency' ? 'pri-emergency' : t.priority === 'urgent' ? 'pri-urgent' : '';
        const timeAgo = getTimeAgo(t.createdAt);
        const store = stores.find(s => s.code === t.storeCode);
        const storeName = store ? store.name.replace(/^Burger King /, 'BK ').replace(/^Paradise QS /, 'PQS ') : t.storeCode;
        const priLabel = lang ? ({routine:'Rutina',urgent:'Urgente',emergency:'Emergencia'}[t.priority]||t.priority) : capitalize(t.priority || 'routine');
        return `<div class="notify-item" onclick="notifyGoToTicket('${esc(t._key || t.id)}', '${esc(t.storeCode)}')">
            <div class="notify-item-title">${getCategoryEmoji(t.category)} ${esc((t.description || '').substring(0, 60))}${(t.description||'').length > 60 ? '...' : ''}</div>
            <div class="notify-item-meta">
                <span class="${priClass}">‚óè ${priLabel}</span>
                <span>${capitalize(t.category)}${t.location ? ' ¬∑ ' + capitalize(t.location) : ''}</span>
                <span>${storeName}</span>
                <span>${timeAgo}</span>
            </div>
        </div>`;
    }).join('');
}

function notifyGoToTicket(key, storeCode) {
    document.getElementById('notifyPanel').classList.remove('open');
    const store = stores.find(s => s.code === storeCode);
    if (store) {
        selectedStore = store;
        const t = notifyTickets.find(x => (x._key === key || x.id === key));
        if (t) {
            if (!t._key) t._key = key;
            if (!currentTickets.find(x => x._key === key)) currentTickets.push(t);
        }
        openTicketDetail(key);
    }
}

// Close notify panel on outside click
document.addEventListener('click', (e) => {
    const panel = document.getElementById('notifyPanel');
    const btn = document.getElementById('notifyBtn');
    if (panel && panel.classList.contains('open') && !panel.contains(e.target) && !btn.contains(e.target)) {
        panel.classList.remove('open');
    }
});

// ============================================================
// ALL TICKETS SCREEN
// ============================================================
let allTicketsData = [];

function showAllTickets(defaultStatus) {
    showScreen('allTicketsScreen');
    const statusSel = document.getElementById('atFilterStatus');
    statusSel.value = defaultStatus || 'open';
    
    // Populate store filter
    const type = document.getElementById('storeType').value;
    document.getElementById('atFilterType').value = type || '';
    populateAllTicketsStoreFilter();
    
    // Load all tickets
    const listEl = document.getElementById('allTicketsList');
    listEl.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-muted)"><span class="spinner spinner-dark"></span> Loading...</div>';
    
    db.ref('tickets').once('value', snap => {
        allTicketsData = [];
        snap.forEach(child => {
            allTicketsData.push(child.val());
        });
        // Sort newest first
        allTicketsData.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        filterAllTickets();
    });
}

function populateAllTicketsStoreFilter() {
    const type = document.getElementById('atFilterType').value;
    const sel = document.getElementById('atFilterStore');
    sel.innerHTML = '<option value="">All Stores</option>';
    let filtered = stores;
    if (type) filtered = stores.filter(s => s.type === type);
    // Permission filter
    if (currentUser.role !== 'Admin' && currentUser.stores !== 'all') {
        const userStores = Array.isArray(currentUser.stores) ? currentUser.stores : [currentUser.stores];
        filtered = filtered.filter(s => userStores.includes(s.code));
    }
    filtered.sort((a, b) => a.name.localeCompare(b.name));
    filtered.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.code;
        opt.textContent = s.name;
        sel.appendChild(opt);
    });
}

function filterAllTickets() {
    populateAllTicketsStoreFilter();
    const status = document.getElementById('atFilterStatus').value;
    const type = document.getElementById('atFilterType').value;
    const storeCode = document.getElementById('atFilterStore').value;
    
    let filtered = allTicketsData;
    
    // Permission filter
    if (currentUser.role !== 'Admin' && currentUser.stores !== 'all') {
        const userStores = Array.isArray(currentUser.stores) ? currentUser.stores : [currentUser.stores];
        filtered = filtered.filter(t => userStores.includes(t.storeCode));
    }
    
    // Status filter
    if (status === 'open') {
        filtered = filtered.filter(t => t.status && t.status !== 'closed' && t.status !== 'resolved');
    } else if (status !== 'all') {
        filtered = filtered.filter(t => (t.status || '').toLowerCase().replace(/\s+/g, '') === status);
    }
    
    // Type filter
    if (type) {
        const typeCodes = stores.filter(s => s.type === type).map(s => s.code);
        filtered = filtered.filter(t => typeCodes.includes(t.storeCode));
    }
    
    // Store filter
    if (storeCode) {
        filtered = filtered.filter(t => t.storeCode === storeCode);
    }
    
    const title = document.getElementById('allTicketsTitle');
    title.textContent = status === 'all' ? `All Tickets (${filtered.length})` : `${status === 'open' ? 'Open' : capitalize(status)} Tickets (${filtered.length})`;
    
    const listEl = document.getElementById('allTicketsList');
    if (filtered.length === 0) {
        listEl.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-muted)">No tickets found</div>';
        return;
    }
    
    listEl.innerHTML = filtered.map(t => {
        const brandIcon = BRAND_LOGOS[t.brand] ? `<img src="${BRAND_LOGOS[t.brand]}" style="height:14px;width:14px;object-fit:contain;border-radius:2px">` : '';
        const timeAgo = getTimeAgo(t.createdAt);
        const photoCount = t.photos ? t.photos.length : 0;
        const shortDesc = (t.description || '').substring(0, 80) + ((t.description || '').length > 80 ? '...' : '');
        const statusClass = (t.status || 'open').toLowerCase().replace(/\s+/g, '');
        const prColor = t.priority === 'emergency' ? '#dc2626' : t.priority === 'urgent' ? '#d97706' : '#059669';
        
        return `<div class="ticket-card" onclick="openTicketFromAll('${esc(t.id)}')">
            <div class="ticket-card-top">
                <span class="ticket-id">${esc(t.id)}</span>
                <span class="ticket-status s-${statusClass}">${(t.status || 'open').toUpperCase()}</span>
            </div>
            <div class="ticket-card-desc">
                <span class="cat-emoji">${getCategoryEmoji(t.category)}</span> ${esc(shortDesc)}
            </div>
            <div class="ticket-card-meta">
                <span style="color:${prColor}">‚óè ${capitalize(t.priority || 'routine')}</span>
                <span>${capitalize(t.category || '')}${t.location ? ' ¬∑ ' + capitalize(t.location) : ''}</span>
                ${brandIcon}
                <span>${timeAgo}</span>
                <span style="color:var(--text-muted)">${esc(t.storeName || t.storeCode)}</span>
                ${photoCount ? '<span>üì∑ ' + photoCount + '</span>' : ''}
            </div>
        </div>`;
    }).join('');
}

function openTicketFromAll(ticketId) {
    const t = allTicketsData.find(x => x.id === ticketId);
    if (!t) return;
    const store = stores.find(s => s.code === t.storeCode);
    if (store) selectedStore = store;
    // Inject into currentTickets so openTicketDetail can find it
    if (!t._key) t._key = ticketId;
    const existing = currentTickets.find(x => x._key === ticketId);
    if (!existing) currentTickets.push(t);
    openTicketDetail(ticketId);
}

// ============================================================
// VIEW AS (itsupport impersonation)
// ============================================================
let realUser = null; // stash the real itsupport user when impersonating

function showViewAsModal() {
    // Load all active users from Firebase
    db.ref('users').once('value', snap => {
        const users = snap.val() || {};
        const entries = Object.entries(users).filter(([uid]) => uid !== currentUser.uid);

        const overlay = document.createElement('div');
        overlay.className = 'admin-modal';
        overlay.id = 'viewAsModal';
        overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
        overlay.innerHTML = `<div class="modal-card">
            <h3>View As Another User</h3>
            <p style="font-size:13px;color:var(--text-mid);margin-bottom:14px">See the app exactly as this user would. You'll keep your admin powers but see their stores and role.</p>
            <div class="form-group">
                <select class="form-select" id="viewAsSelect" style="font-size:14px">
                    <option value="">Choose a user...</option>
                    ${entries.sort((a,b) => (a[1].name||'').localeCompare(b[1].name||'')).map(([uid, u]) =>
                        `<option value="${uid}">${esc(u.name || 'Unknown')} ‚Äî ${esc(u.role || 'Manager')} (${esc(u.email || uid)})</option>`
                    ).join('')}
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="doViewAs()">View As</button>
                ${realUser ? '<button class="btn btn-accent" onclick="exitViewAs()">‚Ü© Back to IT Support</button>' : ''}
                <button class="btn btn-secondary" onclick="document.getElementById('viewAsModal').remove()">Cancel</button>
            </div>
        </div>`;
        document.body.appendChild(overlay);
    });
}

function doViewAs() {
    const uid = document.getElementById('viewAsSelect').value;
    if (!uid) return;

    db.ref(`users/${uid}`).once('value', snap => {
        const data = snap.val();
        if (!data) { showToast('User not found', 'error'); return; }

        // Stash real user if not already impersonating
        if (!realUser) realUser = { ...currentUser };

        // Impersonate
        currentUser = {
            uid: realUser.uid, // keep real auth UID for Firebase writes
            email: data.email || '',
            name: data.name || 'Unknown',
            role: normalizeRole(data.role),
            stores: data.stores || [],
            _impersonating: data.name || data.email
        };

        document.getElementById('viewAsModal').remove();

        // Reset UI
        showScreen('storeSelection');
        document.getElementById('storeType').value = '';
        document.querySelectorAll('.brand-pill').forEach(b => b.classList.remove('active'));
        document.getElementById('storeSelect').innerHTML = '<option value="">Choose store...</option>';
        document.getElementById('actionButtons').classList.add('hidden');
        document.getElementById('mapOverview').classList.add('hidden');
        selectedStore = null;

        // Update header
        const initials = currentUser.name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
        document.getElementById('userAvatar').textContent = initials || '?';
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userRole').innerHTML = currentUser.role + ' <span style="font-size:10px;color:var(--accent);font-weight:700">(viewing as)</span>';

        // Keep admin + viewAs buttons visible
        document.getElementById('adminBtn').classList.remove('hidden');
        document.getElementById('viewAsBtn').classList.remove('hidden');

        // Show/hide All Locations pill based on impersonated user's role
        const allPill = document.getElementById('brandPill-all');
        const allOpt = document.querySelector('.admin-only-opt');
        if (currentUser.role === 'Admin' || currentUser.stores === 'all') {
            if (allPill) allPill.classList.remove('hidden');
            if (allOpt) allOpt.classList.remove('hidden');
        } else {
            if (allPill) allPill.classList.add('hidden');
            if (allOpt) allOpt.classList.add('hidden');
        }

        // Re-run auto-select for single-store managers
        if (currentUser.role === 'Manager' && currentUser.stores && !Array.isArray(currentUser.stores)) {
            const store = stores.find(s => s.code === currentUser.stores);
            if (store) {
                selectedStore = store;
                document.getElementById('storeType').value = store.type;
                filterStores();
                document.getElementById('storeSelect').value = store.id;
                selectStore();
            }
        }

        initNotificationCenter();
        showToast(`Viewing as ${currentUser.name}`, 'success');
    });
}

function exitViewAs() {
    if (!realUser) return;
    currentUser = { ...realUser };
    realUser = null;

    document.getElementById('viewAsModal')?.remove();

    // Reset UI
    showScreen('storeSelection');
    document.getElementById('storeType').value = '';
    document.querySelectorAll('.brand-pill').forEach(b => b.classList.remove('active'));
    document.getElementById('storeSelect').innerHTML = '<option value="">Choose store...</option>';
    document.getElementById('actionButtons').classList.add('hidden');
    document.getElementById('mapOverview').classList.add('hidden');
    selectedStore = null;

    // Restore header
    const initials = currentUser.name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
    document.getElementById('userAvatar').textContent = initials || '?';
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userRole').textContent = currentUser.role;

    // Restore All Locations for admin
    if (currentUser.role === 'Admin' || currentUser.stores === 'all') {
        document.getElementById('brandPill-all').classList.remove('hidden');
        document.querySelector('.admin-only-opt')?.classList.remove('hidden');
    }

    initNotificationCenter();
    showToast('Back to IT Support', 'success');
}

// ============================================================
// NEW ISSUE FORM
// ============================================================
function showNewIssueScreen() {
    if (!selectedStore) return;
    resetNewIssueForm();
    document.getElementById('newIssueStoreName').textContent = selectedStore.name;

    showScreen('newIssueScreen');
}

function resetNewIssueForm() {
    selectedCategory = null;
    selectedPriority = null;
    selectedLocation = null;
    uploadedPhotos = [];
    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
    document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById('issueDescription').value = '';
    document.getElementById('contactName').value = '';
    document.getElementById('contactPhone').value = '';
    document.getElementById('photoPreviewGrid').innerHTML = '';
    document.getElementById('photoUploadArea').classList.remove('has-photos');
    const btn = document.getElementById('submitBtn');
    btn.innerHTML = 'Submit Ticket';
    btn.disabled = false;
}

function selectCategory(el) {
    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    selectedCategory = el.dataset.cat;
}

function selectLocation(el) {
    el.parentElement.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    selectedLocation = el.dataset.loc;
}

function formatPhone(input) {
    let v = input.value.replace(/\D/g, '').substring(0, 10);
    if (v.length >= 7) {
        input.value = v.substring(0,3) + '-' + v.substring(3,6) + '-' + v.substring(6);
    } else if (v.length >= 4) {
        input.value = v.substring(0,3) + '-' + v.substring(3);
    } else {
        input.value = v;
    }
}

function selectPriority(el) {
    document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    selectedPriority = el.dataset.priority;
}

function handlePhotos(input) {
    const files = Array.from(input.files).slice(0, 3 - uploadedPhotos.length);
    files.forEach(file => {
        if (file.size > 5 * 1024 * 1024) { toast('File too large (max 5MB)', 'error'); return; }
        const url = URL.createObjectURL(file);
        uploadedPhotos.push({ file, previewUrl: url });
    });
    renderPhotoPreview();
    input.value = '';
}

function renderPhotoPreview() {
    const grid = document.getElementById('photoPreviewGrid');
    grid.innerHTML = '';
    document.getElementById('photoUploadArea').classList.toggle('has-photos', uploadedPhotos.length > 0);

    uploadedPhotos.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'photo-preview';
        div.innerHTML = `<img src="${p.previewUrl}" alt="Photo"><button class="photo-remove" onclick="removePhoto(${i})">‚úï</button>`;
        grid.appendChild(div);
    });
}

function removePhoto(i) {
    URL.revokeObjectURL(uploadedPhotos[i].previewUrl);
    uploadedPhotos.splice(i, 1);
    renderPhotoPreview();
}

async function submitTicket() {
    // Validate
    if (!selectedCategory) { toast('Select a category', 'error'); return; }
    if (!selectedLocation) { toast('Select interior or exterior', 'error'); return; }
    const contactName = document.getElementById('contactName').value.trim();
    if (!contactName) { toast('Enter your name', 'error'); return; }
    const contactPhone = document.getElementById('contactPhone').value.trim();
    if (!contactPhone || contactPhone.replace(/\D/g,'').length < 10) { toast('Enter a valid phone number', 'error'); return; }
    if (!selectedPriority) { toast('Select a priority', 'error'); return; }
    if (uploadedPhotos.length === 0) { toast('Add at least 1 photo', 'error'); return; }
    const desc = document.getElementById('issueDescription').value.trim();
    if (!desc) { toast('Add a description', 'error'); return; }
    if (desc.length < 10) { toast('Description too short', 'error'); return; }

    const btn = document.getElementById('submitBtn');
    btn.innerHTML = '<span class="spinner"></span> Submitting...';
    btn.disabled = true;

    try {
        // Convert photos to base64 data URLs (stored directly in ticket)
        const photoUrls = [];
        for (const p of uploadedPhotos) {
            const dataUrl = await fileToBase64(p.file);
            photoUrls.push(dataUrl);
        }

        // Generate sequential ticket ID: STORE-CAT-0001
        const catPrefix = {
            plumbing: 'PLM', equipment: 'EQP', it: 'IT',
            structural: 'STR', safety: 'SAF', other: 'GEN'
        }[selectedCategory] || 'GEN';
        
        // Get next number from counter
        const counterRef = db.ref(`counters/${selectedStore.code}/${catPrefix}`);
        const counterSnap = await counterRef.transaction(val => (val || 0) + 1);
        const num = String(counterSnap.snapshot.val()).padStart(4, '0');
        const ticketId = `${selectedStore.code}-${catPrefix}-${num}`;

        // Create ticket in Firebase
        const ticket = {
            id: ticketId,
            storeCode: selectedStore.code,
            storeName: selectedStore.name,
            brand: selectedStore.brand || '',
            category: selectedCategory,
            location: selectedLocation,
            contactName: contactName,
            contactPhone: contactPhone,
            priority: selectedPriority,
            description: desc,
            photos: photoUrls,
            status: 'open',
            createdBy: currentUser.email,
            createdByName: currentUser.name,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            activity: [{
                action: 'created',
                by: currentUser.name,
                byEmail: currentUser.email,
                timestamp: Date.now(),
                note: 'Ticket created'
            }]
        };

        await db.ref(`tickets/${ticketId}`).set(ticket);

        toast('Ticket submitted!', 'success');

        // Navigate to existing issues view for this store
        setTimeout(() => showExistingIssuesScreen(), 600);
    } catch (err) {
        console.error('Submit error:', err);
        toast('Failed to submit. Try again.', 'error');
        btn.innerHTML = 'Submit Ticket';
        btn.disabled = false;
    }
}

// ============================================================
// EXISTING ISSUES
// ============================================================
function showExistingIssuesScreen() {
    if (!selectedStore) return;
    showScreen('existingIssuesScreen');
    document.getElementById('ticketStoreName').textContent = '‚Äî ' + selectedStore.name;
    currentFilter = 'all';
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.toggle('active', c.dataset.filter === 'all'));
    loadTickets();
}

function loadTickets() {
    const listEl = document.getElementById('ticketsList');
    listEl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);"><span class="spinner spinner-dark"></span><br><br>Loading tickets...</div>';

    // Detach previous listener
    if (activeTicketListener) { activeTicketListener(); }

    // Real-time listener for this store's tickets
    const ref = db.ref('tickets').orderByChild('storeCode').equalTo(selectedStore.code);

    const handler = ref.on('value', (snap) => {
        currentTickets = [];
        snap.forEach(child => {
            currentTickets.push({ ...child.val(), _key: child.key });
        });
        // Sort newest first
        currentTickets.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        renderTickets();
    });

    activeTicketListener = () => ref.off('value', handler);
}

function filterTickets(filter, chipEl) {
    currentFilter = filter;
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    if (chipEl) chipEl.classList.add('active');
    renderTickets();
}

function renderTickets() {
    const listEl = document.getElementById('ticketsList');
    let tickets = currentTickets;

    if (currentFilter !== 'all') {
        tickets = tickets.filter(t => t.status === currentFilter);
    }

    if (tickets.length === 0) {
        listEl.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">${currentFilter === 'all' ? 'üì≠' : 'üîç'}</div>
                <h3>${currentFilter === 'all' ? 'No tickets yet' : 'No ' + currentFilter + ' tickets'}</h3>
                <p>${currentFilter === 'all' ? 'All clear at this location!' : 'Try a different filter.'}</p>
            </div>`;
        return;
    }

    listEl.innerHTML = tickets.map(t => {
        const statusLabel = {
            open: 'Open', assigned: 'Assigned', inprogress: 'In Progress',
            waiting: 'Waiting on Parts', resolved: 'Resolved', closed: 'Closed'
        }[t.status] || t.status;

        const catIcons = { plumbing:'üöø', equipment:'‚öôÔ∏è', it:'üíª', structural:'üß±', safety:'üõ°Ô∏è', other:'üìé' };
        const timeAgo = getTimeAgo(t.createdAt);
        const brandLogo = t.brand && BRAND_LOGOS[t.brand] ? `<img src="${BRAND_LOGOS[t.brand]}" alt="" style="width:16px;height:16px;object-fit:contain;border-radius:3px;opacity:.7;vertical-align:middle">` : '';

        return `
        <div class="ticket-card" onclick="openTicketDetail('${t._key}')">
            <div class="ticket-card-inner">
                <div class="ticket-status-bar" style="background: var(--status-${t.status})"></div>
                <div class="ticket-body">
                    <div class="ticket-top-row">
                        <span class="ticket-id">${t.id || t._key}</span>
                        <span class="ticket-status-badge status-${t.status}">${statusLabel}</span>
                    </div>
                    <div class="ticket-title">${catIcons[t.category] || 'üìé'} ${escHtml(t.description.substring(0, 80))}${t.description.length > 80 ? '...' : ''}</div>
                    <div class="ticket-meta">
                        <span><span class="priority-dot ${t.priority}"></span> ${capitalize(t.priority)}</span>
                        <span>${capitalize(t.category)}${t.location ? ' ¬∑ ' + capitalize(t.location) : ''}</span>
                        <span>${brandLogo} ${timeAgo}</span>
                        ${t.photos && t.photos.length ? '<span>üì∑ ' + t.photos.length + '</span>' : ''}
                        ${t.contactPhone ? '<span>üìû</span>' : ''}
                    </div>
                </div>
            </div>
        </div>`;
    }).join('');
}

// ============================================================
// TICKET DETAIL MODAL
// ============================================================
function openTicketDetail(key) {
    const t = currentTickets.find(x => x._key === key);
    if (!t) return;

    document.getElementById('modalTicketId').textContent = t.id || key;

    const catIcons = { plumbing:'üöø', equipment:'‚öôÔ∏è', it:'üíª', structural:'üß±', safety:'üõ°Ô∏è', other:'üìé' };
    const statusLabel = {
        open: 'Open', assigned: 'Assigned', inprogress: 'In Progress',
        waiting: 'Waiting on Parts', resolved: 'Resolved', closed: 'Closed'
    };

    const canUpdateStatus = currentUser.role === 'Admin' || currentUser.role === 'Area Coach';

    let html = `
        <div class="detail-section">
            <span class="ticket-status-badge status-${t.status}" style="font-size: 13px; padding: 5px 14px;">
                ${statusLabel[t.status] || t.status}
            </span>
            <span style="margin-left: 10px; font-size: 13px;">
                <span class="priority-dot ${t.priority}"></span> ${capitalize(t.priority)} Priority
            </span>
        </div>

        <div class="detail-section">
            <div class="detail-label">Category</div>
            <div class="detail-value">${catIcons[t.category] || ''} ${capitalize(t.category)}${t.location ? ' &middot; ' + capitalize(t.location) : ''}</div>
        </div>

        <div class="detail-section">
            <div class="detail-label">Description</div>
            <div class="detail-value">${escHtml(t.description)}</div>
        </div>

        ${t.contactName || t.contactPhone ? '<div class="detail-section"><div class="detail-label">Contact</div><div class="detail-value">' + (t.contactName ? escHtml(t.contactName) : '') + (t.contactPhone ? ' &middot; <a href="tel:' + t.contactPhone.replace(/\D/g,'') + '" style="color:var(--primary);text-decoration:none;font-weight:600">' + escHtml(t.contactPhone) + '</a>' : '') + '</div></div>' : ''}`;

    if (t.photos && t.photos.length) {
        html += `
        <div class="detail-section">
            <div class="detail-label">Photos</div>
            <div class="detail-photos">
                ${t.photos.map(url => `<img src="${url}" class="detail-photo" onclick="openLightbox('${url}')">`).join('')}
            </div>
        </div>`;
    }

    html += `
        <div class="detail-section">
            <div class="detail-label">Reported By</div>
            <div class="detail-value">${escHtml(t.createdByName || t.createdBy)} &middot; ${formatDate(t.createdAt)}</div>
        </div>`;

    // Status update for admins/coaches
    if (canUpdateStatus) {
        const statuses = ['open', 'assigned', 'inprogress', 'waiting', 'resolved', 'closed'];
        html += `
        <div class="status-update-section">
            <h4>Update Status</h4>
            <div class="status-select-grid">
                ${statuses.map(s => `
                    <button class="status-option ${t.status === s ? 'active' : ''}" onclick="updateTicketStatus('${key}', '${s}', this)">
                        ${statusLabel[s]}
                    </button>`).join('')}
            </div>
            <div style="margin-top: 8px;">
                <textarea class="form-textarea" id="statusNote" placeholder="Add a note (optional)..." style="min-height: 60px; font-size: 13px;"></textarea>
            </div>
            <button class="btn btn-primary btn-sm" style="margin-top: 10px;" onclick="saveStatusUpdate('${key}')" id="saveStatusBtn">
                Save Update
            </button>
        </div>`;
    }

    // Activity log
    if (t.activity && t.activity.length) {
        html += `
        <div class="activity-log">
            <h4>Activity</h4>
            ${t.activity.slice().reverse().map(a => `
                <div class="activity-item">
                    <div class="activity-dot" style="background: var(--status-${a.action === 'created' ? 'open' : (a.newStatus || 'open')})"></div>
                    <div>
                        <div class="activity-text"><strong>${escHtml(a.by)}</strong> ${getActivityText(a)}</div>
                        <div class="activity-time">${formatDate(a.timestamp)}</div>
                    </div>
                </div>
            `).join('')}
        </div>`;
    }

    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('ticketModal').classList.add('open');
}

let pendingStatusUpdate = null;

function updateTicketStatus(key, status, el) {
    document.querySelectorAll('.status-option').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    pendingStatusUpdate = { key, status };
}

async function saveStatusUpdate(key) {
    const t = currentTickets.find(x => x._key === key);
    if (!t) return;

    const newStatus = pendingStatusUpdate ? pendingStatusUpdate.status : t.status;
    const note = document.getElementById('statusNote')?.value?.trim() || '';

    if (newStatus === t.status && !note) {
        toast('No changes to save', 'error');
        return;
    }

    const btn = document.getElementById('saveStatusBtn');
    btn.innerHTML = '<span class="spinner"></span>';
    btn.disabled = true;

    try {
        const updates = {};
        updates[`tickets/${key}/updatedAt`] = firebase.database.ServerValue.TIMESTAMP;

        if (newStatus !== t.status) {
            updates[`tickets/${key}/status`] = newStatus;
        }

        // Append activity
        const activityItem = {
            action: newStatus !== t.status ? 'status_change' : 'note',
            by: currentUser.name,
            byEmail: currentUser.email,
            timestamp: Date.now(),
            ...(newStatus !== t.status && { oldStatus: t.status, newStatus }),
            ...(note && { note })
        };

        // Get current activity array length and push
        const actSnap = await db.ref(`tickets/${key}/activity`).once('value');
        const currentActivity = actSnap.val() || [];
        currentActivity.push(activityItem);
        updates[`tickets/${key}/activity`] = currentActivity;

        await db.ref().update(updates);

        toast('Ticket updated!', 'success');
        closeModal();
    } catch (err) {
        console.error('Update error:', err);
        toast('Update failed', 'error');
    } finally {
        btn.innerHTML = 'Save Update';
        btn.disabled = false;
    }
}

function closeModal() {
    document.getElementById('ticketModal').classList.remove('open');
    pendingStatusUpdate = null;
}

// ============================================================
// LIGHTBOX
// ============================================================
function openLightbox(url) {
    event.stopPropagation();
    document.getElementById('lightboxImg').src = url;
    document.getElementById('lightbox').classList.add('open');
}

function closeLightbox() {
    document.getElementById('lightbox').classList.remove('open');
}

// ============================================================
// UTILITIES
// ============================================================
function toast(msg, type = '') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast show ' + type;
    setTimeout(() => el.className = 'toast', 3000);
}

function escHtml(str) {
    const div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
}
const esc = escHtml;

function normalizeRole(r) {
    if (!r) return 'Manager';
    const lower = r.toLowerCase();
    if (lower === 'admin') return 'Admin';
    if (lower === 'areacoach' || lower === 'area coach') return 'Area Coach';
    return 'Manager';
}

function goHome() {
    showScreen('storeSelection');
    document.getElementById('storeType').value = '';
    document.querySelectorAll('.brand-pill').forEach(b => b.classList.remove('active'));
    document.getElementById('storeSelect').innerHTML = '<option value="">Choose store...</option>';
    document.getElementById('actionButtons').classList.add('hidden');
    document.getElementById('mapOverview').classList.add('hidden');
    selectedStore = null;
    if (activeTicketListener) { activeTicketListener(); activeTicketListener = null; }
}

// ============================================================
// DARK MODE
// ============================================================
const LIGHT_TILES = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
const DARK_TILES = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
let currentTileLayer = null;

function toggleTheme() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (isDark) {
        document.documentElement.removeAttribute('data-theme');
        document.getElementById('themeToggle').textContent = 'üåô';
        localStorage.setItem('theme', 'light');
    } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
        localStorage.setItem('theme', 'dark');
    }
    // Swap map tiles if map is active
    if (overviewMap && currentTileLayer) {
        overviewMap.removeLayer(currentTileLayer);
        currentTileLayer = L.tileLayer(isDark ? LIGHT_TILES : DARK_TILES, {
            attribution: '¬© CartoDB',
            maxZoom: 18
        }).addTo(overviewMap);
    }
}

// Restore saved theme on load
(function() {
    const saved = localStorage.getItem('theme');
    if (saved === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        setTimeout(() => {
            const btn = document.getElementById('themeToggle');
            if (btn) btn.textContent = '‚òÄÔ∏è';
        }, 0);
    }
})();

// ============================================================
// LANGUAGE / i18n
// ============================================================
let currentLang = localStorage.getItem('lang') || 'en';

const TRANSLATIONS = {
    es: {
        // Store selection
        select_store: 'Selecciona Tu Tienda',
        select_store_sub: 'Elige una ubicaci√≥n para reportar o ver problemas',
        store_type: 'Tipo de Tienda',
        location_label: 'Ubicaci√≥n',
        // Form
        report_new: 'Reportar Nuevo Problema',
        form_category: 'Categor√≠a',
        form_location: 'Ubicaci√≥n',
        form_name: 'Tu Nombre',
        form_phone: 'Tu Tel√©fono de Contacto',
        form_priority: 'Prioridad',
        form_description: 'Descripci√≥n',
        form_photos: 'Fotos',
        form_photos_hint: '(requerida, al menos 1, m√°ximo 3)',
        // Categories
        cat_plumbing: 'Plomer√≠a',
        cat_equipment: 'Equipo',
        cat_it: 'IT',
        cat_structural: 'Estructural',
        cat_safety: 'Seguridad',
        cat_other: 'Otro',
        // Location
        loc_interior: 'Interior',
        loc_exterior: 'Exterior',
        // Priority
        p_routine: 'Rutina',
        p_routine_desc: 'Hasta 1 semana',
        p_urgent: 'Urgente',
        p_urgent_desc: 'Dentro de 72 horas',
        p_emergency: 'Emergencia',
        p_emergency_desc: 'Dentro de 24 horas',
        // Actions
        report_issue: 'Reportar Nuevo Problema',
        view_tickets: 'Ver Tickets Existentes',
        back_store: '‚Üê Volver a la tienda',
        sign_out: 'Cerrar Sesi√≥n',
        tap_photos: 'Toca para a√±adir fotos',
        photo_hint: 'JPG o PNG, m√°ximo 5MB cada una',
        notifications: 'Notificaciones',
        all_locations: 'Todas las Ubicaciones',
    }
};

function toggleLang() {
    currentLang = currentLang === 'en' ? 'es' : 'en';
    localStorage.setItem('lang', currentLang);
    applyLang();
}

function applyLang() {
    const btn = document.getElementById('langToggle');
    if (btn) btn.textContent = currentLang === 'en' ? 'EN' : 'ES';

    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (currentLang === 'es' && TRANSLATIONS.es[key]) {
            if (!el.getAttribute('data-orig')) {
                el.setAttribute('data-orig', el.textContent);
            }
            el.textContent = TRANSLATIONS.es[key];
        } else if (currentLang === 'en' && el.getAttribute('data-orig')) {
            el.textContent = el.getAttribute('data-orig');
        }
    });

    // Update placeholders
    const nameInput = document.getElementById('contactName');
    if (nameInput) nameInput.placeholder = currentLang === 'es' ? 'Nombre de la persona reportando' : 'Name of person reporting issue';
    const phoneInput = document.getElementById('contactPhone');
    if (phoneInput) phoneInput.placeholder = currentLang === 'es' ? '555-123-4567' : '555-123-4567';
    const descInput = document.getElementById('issueDescription');
    if (descInput) descInput.placeholder = currentLang === 'es'
        ? 'Describe el problema en detalle. ¬øQu√© est√° roto? ¬øD√≥nde exactamente? ¬øCu√°ndo empez√≥?'
        : "Describe the issue in detail. What's broken? Where exactly? When did it start?";

    // Submit button
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn && !submitBtn.disabled) {
        submitBtn.textContent = currentLang === 'es' ? 'Enviar Ticket' : 'Submit Ticket';
    }

    // Store select placeholder
    const storeSel = document.getElementById('storeSelect');
    if (storeSel && storeSel.options[0]) {
        storeSel.options[0].textContent = currentLang === 'es' ? 'Elige tienda...' : 'Choose store...';
    }
    const typeSel = document.getElementById('storeType');
    if (typeSel && typeSel.options[0]) {
        typeSel.options[0].textContent = currentLang === 'es' ? 'Elige tipo...' : 'Choose type...';
    }
}

// Apply saved language on load
(function() {
    setTimeout(applyLang, 100);
})();

function getCategoryEmoji(cat) {
    const map = {plumbing:'üöø',equipment:'‚öôÔ∏è',it:'üíª',structural:'üß±',safety:'üõ°Ô∏è',other:'üìé'};
    return map[cat] || 'üìé';
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + type + ' show';
    setTimeout(() => t.className = 'toast', 3000);
}

function capitalize(s) {
    return s ? s.charAt(0).toUpperCase() + s.slice(1) : '';
}

function getTimeAgo(ts) {
    if (!ts) return '';
    const diff = Date.now() - ts;
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'Just now';
    if (mins < 60) return mins + 'm ago';
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    const days = Math.floor(hrs / 24);
    if (days < 30) return days + 'd ago';
    return formatDate(ts);
}

function formatDate(ts) {
    if (!ts) return '';
    const d = new Date(ts);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function getActivityText(a) {
    if (a.action === 'created') return 'created this ticket';
    if (a.action === 'status_change') {
        const labels = { open:'Open', assigned:'Assigned', inprogress:'In Progress', waiting:'Waiting on Parts', resolved:'Resolved', closed:'Closed' };
        let text = `changed status to <strong>${labels[a.newStatus] || a.newStatus}</strong>`;
        if (a.note) text += ` ‚Äî "${escHtml(a.note)}"`;
        return text;
    }
    if (a.action === 'note') return `added a note: "${escHtml(a.note)}"`;
    return a.action;
}

// Close modal on Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeLightbox();
        closeModal();
    }
});
</script>
</body>
</html>
